<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ ·æ–¹æ³•æ¨¡æ‹Ÿå®éªŒ (ç¯å½¢åŒºåŸŸç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --highlight-color: #e74c3c;
            --bg-color: #f5f6fa;
            --panel-bg: #ffffff;
            --border-color: #dcdde1;
            /* ç”¨äºæ§åˆ¶ç¯å½¢å†…å¾„çš„å˜é‡ */
            --inner-radius-pct: 33%; 
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
            height: 100vh;
            display: flex;
            background-color: var(--bg-color);
            overflow: hidden;
        }

        /* å¸ƒå±€: å·¦æ§å³æ¨¡ */
        @media (min-width: 768px) {
            body { flex-direction: row; }
            #control-panel {
                width: 320px;
                border-right: 1px solid var(--border-color);
                order: 1;
            }
            #simulation-container {
                flex: 1;
                order: 2;
            }
        }

        /* æ‰‹æœº: ä¸Šæ¨¡ä¸‹æ§ */
        @media (max-width: 767px) {
            body { flex-direction: column; }
            #simulation-container {
                flex: 1;
                order: 1; 
            }
            #control-panel {
                height: 50%;
                order: 2;
                border-top: 1px solid var(--border-color);
                overflow-y: auto;
            }
        }

        /* æ¨¡æ‹ŸåŒºå®¹å™¨ */
        #simulation-container {
            position: relative;
            background-color: #e8f5e9; /* å¤–éƒ¨è‰åœ°è‰² */
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* æ ¸å¿ƒåŒºåŸŸ: ç¯å½¢ä¿®æ”¹ */
        #simulation-area {
            width: 100%;
            max-width: 80vh; 
            aspect-ratio: 1 / 1;
            /* 
               åˆ©ç”¨å¾„å‘æ¸å˜æ¨¡æ‹Ÿç¯å½¢ï¼š
               ä¸­é—´æ˜¯é€æ˜(é€å‡ºèƒŒæ™¯è‰²æˆ–è®¾ä¸ºç°è‰²è¡¨ç¤ºç©ºæ´)ï¼Œå¤–åœˆæ˜¯ç™½è‰²(æœ‰æ•ˆåŒºåŸŸ) 
            */
            background-color: transparent;
            background-image: radial-gradient(circle, #bdc3c7 0%, #bdc3c7 var(--inner-radius-pct), #ffffff var(--inner-radius-pct), #ffffff 100%);
            border: 2px solid #333;
            position: relative;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            border-radius: 50%; 
            overflow: hidden;   
        }
        /* ç»™å†…åœ†åŠ ä¸ªè™šçº¿è¾¹æ¡†æ•ˆæœï¼ˆå¯é€‰ï¼Œç”¨ä¼ªå…ƒç´ æ¨¡æ‹Ÿæ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œåªé èƒŒæ™¯è‰²åŒºåˆ†ï¼‰ */

        .plant {
            position: absolute;
            background-color: #27ae60; 
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 1;
        }

        .quadrat {
            position: absolute;
            border: 2px dashed red;
            background-color: rgba(255, 0, 0, 0.1);
            z-index: 10;
            cursor: grab;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            color: red;
            font-weight: bold;
            transform: translate(-50%, -50%); 
        }
        .quadrat.completed {
            border-color: #27ae60;
            background-color: rgba(39, 174, 96, 0.2);
            color: #27ae60;
        }

        .toast-bubble {
            position: fixed;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -100%);
            margin-top: -10px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .toast-bubble.show { opacity: 1; }

        #control-panel {
            background-color: var(--panel-bg);
            display: flex;
            flex-direction: column;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background: #f1f2f6;
            flex-shrink: 0;
        }
        .tab-btn {
            flex: 1;
            padding: 12px;
            background: #f1f2f6;
            border: none;
            font-weight: bold;
            color: #7f8c8d;
            font-size: 14px;
            cursor: pointer;
        }
        .tab-btn.active {
            background: #fff;
            color: var(--primary-color);
            border-bottom: 2px solid var(--accent-color);
        }
        .tab-content { display: none; padding: 15px; flex: 1; overflow-y: auto; }
        .tab-content.active { display: block; }

        .section { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .section-title { font-weight: bold; margin-bottom: 8px; color: var(--primary-color); font-size: 14px; }
        
        .preset-scroll { display: flex; gap: 8px; margin-bottom: 8px; overflow-x: auto; }
        .preset-item {
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            background: #fff;
            font-size: 13px;
            white-space: nowrap;
        }
        .preset-item.selected {
            border-color: var(--accent-color);
            background-color: #ebf5fb;
            color: var(--accent-color);
        }

        .btn {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
        }
        .action-group { display: flex; gap: 8px; margin-bottom: 10px; }
        .btn.highlight { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
        .btn-danger.highlight { background-color: var(--highlight-color); border-color: var(--highlight-color); }
        .btn-primary { background-color: var(--primary-color); color: white; border: none; font-size: 14px; margin-top: 5px; }

        .info-display { background: #f8f9fa; padding: 8px; border-radius: 4px; font-size: 12px; color: #666; line-height: 1.4; margin-bottom: 8px; }
        .result-box { background: #fdfefe; border: 1px solid #dcdde1; padding: 10px; margin-top: 10px; font-size: 13px; border-radius: 4px; }
        .result-line { display: flex; justify-content: space-between; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px dashed #eee; }

        .setting-item { margin-bottom: 15px; }
        .setting-item label { display: block; margin-bottom: 5px; font-size: 13px; }
        .range-wrap { display: flex; align-items: center; gap: 10px; font-size: 12px; }
        input[type="range"] { flex: 1; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: none;
            justify-content: center; align-items: center; z-index: 2000;
        }
        .modal {
            background: white; padding: 20px; border-radius: 8px; width: 300px;
            display: flex; flex-direction: column; gap: 15px;
        }
        .quadrat-view-container {
            width: 200px; height: 200px; margin: 0 auto;
            position: relative; background: #f9f9f9; border: 1px solid #ddd; overflow: hidden;
        }

    </style>
</head>
<body>

    <div id="toast-bubble" class="toast-bubble">æç¤ºä¿¡æ¯</div>

    <div id="control-panel">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('main')">ä¸»è¦åŠŸèƒ½</button>
            <button class="tab-btn" onclick="switchTab('settings')">è®¾ç½®</button>
        </div>

        <div id="tab-main" class="tab-content active">
            <div class="section">
                <div class="section-title">æ ·æ–¹é¢„è®¾ (æ­£æ–¹å½¢)</div>
                <div class="preset-scroll">
                    <div class="preset-item selected" onclick="selectPreset(1, this)">1m</div>
                    <div class="preset-item" onclick="selectPreset(2, this)">2m</div>
                    <div class="preset-item" onclick="selectPreset(5, this)">5m</div>
                    <div class="preset-item" onclick="selectPreset('custom', this)">è‡ªå®šä¹‰</div>
                </div>
                <div id="preset-info" class="info-display">å½“å‰é€‰æ‹©: è¾¹é•¿ 1m</div>
                <div id="custom-input-div" style="display:none; align-items:center; gap:10px; margin-bottom:5px; font-size:13px;">
                    <label>è¾¹é•¿(m):</label>
                    <input type="number" id="custom-size-input" value="10" min="1" max="100" style="width:60px; padding:4px;">
                </div>
            </div>

            <div class="section">
                <div class="section-title">æ“ä½œæ¨¡å¼</div>
                <div class="action-group">
                    <button class="btn" id="btn-place" onclick="setMode('place')">æ”¾ç½®</button>
                    <button class="btn" id="btn-move" onclick="setMode('move')">ç§»åŠ¨</button>
                    <button class="btn btn-danger" id="btn-delete" onclick="setMode('delete')">åˆ é™¤</button>
                </div>
                <div class="info-display" id="mode-info">è¯·é€‰æ‹©æ“ä½œæ¨¡å¼</div>
            </div>

            <div class="section">
                <button class="btn btn-primary" id="btn-start-stats" onclick="startStatistics()">å¼€å§‹ç»Ÿè®¡</button>
                
                <div id="stats-panel" style="display:none; margin-top: 15px;">
                    <div class="info-display">
                        ç»Ÿè®¡ä¸­... è¯·ç‚¹å‡»çº¢è‰²æ ·æ–¹å½•å…¥æ•°æ®<br>
                        ç›®æ ‡ï¼šä»…ç»Ÿè®¡ç™½è‰²ç¯å½¢åŒºåŸŸå†…çš„æ¤ç‰©<br>
                        å…¬å¼: æ€»å¯†åº¦ = Î£(æ ·æ–¹å¯†åº¦) / æ ·æ–¹æ•°
                    </div>
                    
                    <div id="result-display" style="display:none;">
                        <div class="result-box" style="border-left: 4px solid var(--accent-color);">
                            <div class="section-title">ç»Ÿè®¡ç»“æœæŠ¥å‘Š</div>
                            <div class="result-line"><span>æ‚¨çš„ä¼°ç®—å¯†åº¦:</span> <strong id="user-density">--</strong> æ ª/mÂ²</div>
                            <div class="result-line"><span>çœŸå®å¯†åº¦:</span> <strong id="true-density">--</strong> æ ª/mÂ²</div>
                            <div class="result-line"><span>ç›¸å¯¹è¯¯å·®:</span> <strong id="error-rate" style="color:red">--</strong>%</div>
                            <div style="font-size:10px; color:#999; margin-top:5px;">(çœŸå®å¯†åº¦åŸºäºç¯å½¢æ€»é¢ç§¯è®¡ç®—)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="section">
                <div class="setting-item">
                    <label>åŒºåŸŸç›´å¾„ (m) [å¤–å¾„]:</label>
                    <input type="number" id="setting-area-size" value="15" onchange="updateSettings()">
                </div>
                <!-- æ–°å¢ï¼šå†…åœ†è®¾ç½® -->
                <div class="setting-item">
                    <label>ä¸­é—´ç©ºæ´ç›´å¾„ (m) [å†…å¾„]:</label>
                    <div class="range-wrap">
                        <span id="inner-size-min">0m</span>
                        <input type="range" id="setting-inner-size" min="0" max="14" step="1" value="5" oninput="updateSettingsUI();" onchange="updateSettings()">
                        <span id="inner-size-val">5m</span>
                    </div>
                    <div class="info-display" style="margin-top:5px;">ç°è‰²åŒºåŸŸä¸ºä¸å¯ç”Ÿé•¿åŒº</div>
                </div>

                <div class="setting-item">
                    <label>éšæœºåˆ†å¸ƒç§å­ (Seed):</label>
                    <div style="display:flex; gap:8px;">
                        <input type="number" id="setting-seed" value="12345" style="flex:1; padding:5px; border:1px solid #ddd; border-radius:4px;" onchange="updateSettings()">
                        <button class="btn" style="width: auto; padding: 0 12px;" onclick="randomizeSeed()" title="ç”Ÿæˆéšæœºç§å­">ğŸ²</button>
                    </div>
                    <div class="info-display" style="margin-top:5px; margin-bottom:0;">ä¿®æ”¹ç§å­æˆ–ç‚¹å‡»é‡ç½®åï¼Œåˆ†å¸ƒå°†æ”¹å˜ã€‚</div>
                </div>

                <div class="setting-item">
                    <label>æ¤ç‰©æ•°é‡ (1k-4k): <span id="plant-count-val">2000</span></label>
                    <div class="range-wrap">
                        <span>1k</span>
                        <input type="range" id="setting-plant-count" min="1000" max="4000" value="2000" oninput="updateSettingsUI();" onchange="updateSettings()">
                        <span>4k</span>
                    </div>
                </div>
                <div class="setting-item">
                    <label>æ¤ç‰©ç¦»æ•£åº¦ (0=èšé›†, 1=éšæœº): <span id="dispersion-val">0</span></label>
                    <div class="range-wrap">
                        <span>0</span>
                        <input type="range" id="setting-dispersion" min="0" max="1" step="0.1" value="0" oninput="updateSettingsUI();" onchange="updateSettings()">
                        <span>1</span>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="resetSimulation()">é‡ç½®å¹¶åº”ç”¨è®¾ç½®</button>
            </div>
        </div>
    </div>

    <div id="simulation-container">
        <div id="simulation-area"></div>
        <div style="position: absolute; bottom: 5px; right: 10px; font-size: 12px; color: #555; background:rgba(255,255,255,0.8); padding:4px 6px; border-radius:3px; pointer-events: none;">
            ç¯å½¢: å¤–å¾„ <span id="area-outer-label">15</span>m / å†…å¾„ <span id="area-inner-label">5</span>m
        </div>
    </div>

    <div class="modal-overlay" id="count-modal">
        <div class="modal">
            <div class="modal-header" style="text-align: center; font-weight: bold; padding-bottom:10px; border-bottom:1px solid #eee;">æ ·æ–¹è®¡æ•°å½•å…¥</div>
            <div style="font-size: 12px; color: #666; text-align: center;">æ ·æ–¹è§†é‡ (çº¢è‰²è™šçº¿ä¸ºæ ·æ–¹è¾¹ç•Œ)</div>
            <div class="quadrat-view-container" id="modal-view"></div>
            <div>
                <label style="font-size:13px; font-weight:bold;">è¯·è¾“å…¥ç»Ÿè®¡æ•°é‡:</label>
                <input type="text" id="modal-input-count" style="width: 100%; margin-top: 5px; padding: 10px; font-size:16px;">
            </div>
            <div class="modal-actions" style="display:flex; gap:10px;">
                <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn highlight" onclick="submitCount()">ç¡®è®¤å½•å…¥</button>
            </div>
        </div>
    </div>

<script>
    const state = {
        mode: null, 
        settings: { 
            areaSize: 15, 
            innerSize: 5, // æ–°å¢ï¼šå†…åœ†ç›´å¾„
            plantCount: 2000, 
            dispersion: 0, 
            seed: 12345 
        },
        currentPreset: 1, customSize: 10,
        plants: [], quadrats: [],
        nextId: 1
    };

    const DOM = {
        simArea: document.getElementById('simulation-area'),
        modal: document.getElementById('count-modal'),
        toast: document.getElementById('toast-bubble'),
        btns: {
            place: document.getElementById('btn-place'),
            move: document.getElementById('btn-move'),
            delete: document.getElementById('btn-delete')
        }
    };

    function createSeededRandom(seed) {
        return function() {
            seed = (seed * 9301 + 49297) % 233280;
            return seed / 233280;
        };
    }

    function init() {
        updateSettingsUI();
        // å¼ºåˆ¶åˆå§‹åŒ–ä¸€æ¬¡é€»è¾‘
        updateSettings();
        generatePlants();
        setupEventListeners();
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
        const idx = tabName === 'main' ? 0 : 1;
        document.querySelectorAll('.tab-btn')[idx].classList.add('active');
    }

    function updateSettingsUI() {
        document.getElementById('plant-count-val').innerText = document.getElementById('setting-plant-count').value;
        document.getElementById('dispersion-val').innerText = document.getElementById('setting-dispersion').value;
        document.getElementById('setting-seed').value = state.settings.seed;
        
        // æ›´æ–°å†…å¾„æ»‘å—ä¸Šé™ï¼ˆä¸èƒ½è¶…è¿‡å¤–å¾„ï¼‰
        const outerVal = parseInt(document.getElementById('setting-area-size').value);
        const innerSlider = document.getElementById('setting-inner-size');
        const innerValDisplay = document.getElementById('inner-size-val');
        
        innerSlider.max = Math.max(0, outerVal - 1); // è‡³å°‘ç•™1m
        innerValDisplay.innerText = innerSlider.value + 'm';
    }

    function updateSettings() {
        state.settings.areaSize = parseInt(document.getElementById('setting-area-size').value);
        state.settings.innerSize = parseInt(document.getElementById('setting-inner-size').value);
        state.settings.plantCount = parseInt(document.getElementById('setting-plant-count').value);
        state.settings.dispersion = parseFloat(document.getElementById('setting-dispersion').value);
        
        let seedInput = parseInt(document.getElementById('setting-seed').value);
        if(!isNaN(seedInput)) state.settings.seed = seedInput;

        // æ›´æ–°æ ‡ç­¾
        document.getElementById('area-outer-label').innerText = state.settings.areaSize;
        document.getElementById('area-inner-label').innerText = state.settings.innerSize;

        // æ›´æ–°CSSå˜é‡ä»¥ç»˜åˆ¶ç©ºæ´
        const innerPct = (state.settings.innerSize / state.settings.areaSize) * 100;
        document.documentElement.style.setProperty('--inner-radius-pct', innerPct + '%');
    }

    function randomizeSeed() {
        const newSeed = Math.floor(Math.random() * 100000);
        state.settings.seed = newSeed;
        document.getElementById('setting-seed').value = newSeed;
        resetSimulation();
    }

    function resetSimulation() {
        updateSettings();
        state.quadrats.forEach(q => q.element.remove());
        state.quadrats = [];
        state.mode = null;
        resetUIState();
        generatePlants();
        switchTab('main');
    }

    function generatePlants() {
        DOM.simArea.innerHTML = '';
        state.plants = [];
        
        const rng = createSeededRandom(state.settings.seed);
        const plantSize = 4;
        const clusters = Math.max(1, Math.floor(state.settings.plantCount / 20));
        const clusterCenters = [];
        
        // åŠå¾„å¹³æ–¹é˜ˆå€¼
        const R_OUT_SQ = 2500; // 50^2
        const innerPct = (state.settings.innerSize / state.settings.areaSize) * 100;
        const R_IN_SQ = Math.pow(innerPct / 2, 2);

        // ç”Ÿæˆèšè½ä¸­å¿ƒï¼ˆå¿…é¡»åœ¨ç¯å†…ï¼‰
        for(let i=0; i<clusters; i++) {
            let cx, cy, distSq;
            do {
                cx = rng() * 100;
                cy = rng() * 100;
                distSq = Math.pow(cx - 50, 2) + Math.pow(cy - 50, 2);
            } while (distSq > R_OUT_SQ || distSq < R_IN_SQ); // å¿…é¡»åœ¨ç¯å†…
            clusterCenters.push({x: cx, y: cy});
        }

        for (let i = 0; i < state.settings.plantCount; i++) {
            let x, y;
            let valid = false;
            let attempts = 0;
            
            // å¾ªç¯å°è¯•ç”Ÿæˆ
            while(!valid && attempts < 20) {
                attempts++;
                if (rng() < state.settings.dispersion) {
                    x = rng() * 100;
                    y = rng() * 100;
                } else {
                    const centerIdx = Math.floor(rng() * clusters);
                    const center = clusterCenters[centerIdx];
                    const offset = () => (rng() - 0.5) * 15;
                    x = center.x + offset();
                    y = center.y + offset();
                }
                
                const distSq = Math.pow(x - 50, 2) + Math.pow(y - 50, 2);
                // æ ¡éªŒï¼šåœ¨åœ†å†… ä¸” åœ¨ç©ºæ´å¤–
                if (distSq <= R_OUT_SQ && distSq >= R_IN_SQ) {
                    valid = true;
                }
            }

            if (valid) {
                state.plants.push({x, y});
                const dot = document.createElement('div');
                dot.className = 'plant'; 
                dot.style.width = plantSize + 'px';
                dot.style.height = plantSize + 'px';
                dot.style.left = x + '%';
                dot.style.top = y + '%';
                DOM.simArea.appendChild(dot);
            }
        }
    }

    function selectPreset(size, el) {
        if (state.quadrats.length > 0 && state.mode === 'place') return;
        state.currentPreset = size;
        document.querySelectorAll('.preset-item').forEach(i => i.classList.remove('selected'));
        el.classList.add('selected');
        const display = document.getElementById('preset-info');
        const customDiv = document.getElementById('custom-input-div');
        
        if (size === 'custom') {
            customDiv.style.display = 'flex';
            const val = document.getElementById('custom-size-input').value;
            display.innerText = `å½“å‰é€‰æ‹©: è‡ªå®šä¹‰ ${val}m`;
        } else {
            customDiv.style.display = 'none';
            display.innerText = `å½“å‰é€‰æ‹©: è¾¹é•¿ ${size}m`;
        }
    }

    document.getElementById('custom-size-input').addEventListener('input', (e) => {
        state.customSize = parseInt(e.target.value) || 1;
        document.getElementById('preset-info').innerText = `å½“å‰é€‰æ‹©: è‡ªå®šä¹‰ ${state.customSize}m`;
    });

    function setMode(mode) {
        Object.values(DOM.btns).forEach(b => b.classList.remove('highlight'));
        if (state.mode === mode) {
            state.mode = null;
            document.getElementById('mode-info').innerText = "æ“ä½œå·²å–æ¶ˆ";
            return;
        }
        state.mode = mode;
        if(DOM.btns[mode]) DOM.btns[mode].classList.add('highlight');
        const map = {
            'place': 'ç‚¹å‡»ç™½è‰²åŒºåŸŸæ”¾ç½®æ ·æ–¹ (éœ€å®Œå…¨åœ¨ç¯å¸¦å†…)',
            'move': 'æ‹–æ‹½æ ·æ–¹è¿›è¡Œç§»åŠ¨',
            'delete': 'ç‚¹å‡»æ ·æ–¹åˆ é™¤'
        };
        document.getElementById('mode-info').innerText = map[mode] || "";
    }

    function setupEventListeners() {
        DOM.simArea.addEventListener('mousedown', handleAreaInteraction);
        DOM.simArea.addEventListener('touchstart', handleAreaInteraction, {passive: false});
    }

    let toastTimer = null;
    function showToast(x, y, text) {
        DOM.toast.innerText = text;
        DOM.toast.style.left = x + 'px';
        DOM.toast.style.top = y + 'px';
        DOM.toast.classList.add('show');
        
        if(toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
            DOM.toast.classList.remove('show');
        }, 2000);
    }

    function handleAreaInteraction(e) {
        if (state.mode !== 'place') return;
        if(e.cancelable) e.preventDefault();

        const rect = DOM.simArea.getBoundingClientRect();
        let clientX = e.clientX;
        let clientY = e.clientY;
        if(e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        }

        const xPct = ((clientX - rect.left) / rect.width) * 100;
        const yPct = ((clientY - rect.top) / rect.height) * 100;

        addQuadrat(xPct, yPct, clientX, clientY);
    }

    /**
     * è®¡ç®—åˆæ³•ä½ç½®ï¼š
     * 1. æ ·æ–¹å››è§’å¿…é¡»åœ¨ å¤–åœ†(R=50) å†…ã€‚
     * 2. æ ·æ–¹å¿…é¡»å®Œå…¨åœ¨ å†…åœ†(r=inner/2) å¤–ã€‚
     */
    function clampPosition(x, y, sizePct) {
        const h = sizePct / 2;
        const cx = 50, cy = 50;
        const R_OUT = 50;
        // è®¡ç®—å†…åœ†åŠå¾„ (ç™¾åˆ†æ¯”å•ä½)
        const innerPct = (state.settings.innerSize / state.settings.areaSize) * 100;
        const R_IN = innerPct / 2;

        // 1. å¤–åœ†çº¦æŸ (Outer Constraint) - åŒå‰ç‰ˆ
        let vx = x - cx;
        let vy = y - cy;
        // æœ€è¿œè§’åˆ°åœ†å¿ƒè·ç¦»
        let distFarSq = Math.pow(Math.abs(vx) + h, 2) + Math.pow(Math.abs(vy) + h, 2);

        // å¦‚æœè¶…å‡ºå¤–åœ†ï¼Œæ‹‰å›
        if (distFarSq > R_OUT * R_OUT) {
            const A = Math.abs(vx);
            const B = Math.abs(vy);
            const a = A*A + B*B;
            const b = 2*h*(A + B);
            const c = 2*h*h - R_OUT*R_OUT;
            
            if (a > 0.0001) {
                const delta = b*b - 4*a*c;
                if (delta >= 0) {
                    const k = (-b + Math.sqrt(delta)) / (2*a);
                    if (k >= 0 && k < 1) {
                        vx *= k;
                        vy *= k;
                        x = cx + vx;
                        y = cy + vy;
                    }
                }
            } else {
                x = 50; y = 50; vx = 0; vy = 0;
            }
        }

        // 2. å†…åœ†çº¦æŸ (Inner Constraint) - æ ·æ–¹ä¸èƒ½ç¢°åˆ°å†…åœ†
        // å³ï¼šåœ†å¿ƒåˆ°çŸ©å½¢çš„"æœ€è¿‘è·ç¦»"å¿…é¡» >= R_IN
        // çŸ©å½¢èŒƒå›´: [x-h, x+h], [y-h, y+h]
        // è·ç¦»å…¬å¼: dist = sqrt(dx^2 + dy^2), å…¶ä¸­ dx = max(0, |cx - rectX| - h)
        // ä½†è¿™é‡ŒçŸ©å½¢ä¸­å¿ƒæ˜¯ (x,y)ï¼Œåœ†å¿ƒæ˜¯ (50,50)ã€‚
        // å‘é‡ v = (x-50, y-50)ã€‚
        // çŸ©å½¢æœ€è¿‘ç‚¹åˆ°(50,50)çš„è·ç¦»: 
        // d_close^2 = max(0, |x-50| - h)^2 + max(0, |y-50| - h)^2
        
        // æˆ‘ä»¬éœ€è¦ d_close >= R_IN
        // å¦‚æœ d_close < R_INï¼Œæˆ‘ä»¬éœ€è¦æŠŠ (x,y) æ²¿ç€ v æ–¹å‘å¾€å¤–æ¨ã€‚
        
        // é‡æ–°è®¡ç®— vx, vy (åŸºäºå¤–åœ†çº¦æŸä¿®æ­£åçš„)
        vx = x - 50;
        vy = y - 50;
        
        const absVx = Math.abs(vx);
        const absVy = Math.abs(vy);
        
        // è®¡ç®—å½“å‰æœ€è¿‘è·ç¦»å¹³æ–¹
        const dxClosest = Math.max(0, absVx - h);
        const dyClosest = Math.max(0, absVy - h);
        const distCloseSq = dxClosest*dxClosest + dyClosest*dyClosest;

        if (distCloseSq < R_IN * R_IN) {
            // éœ€è¦å‘å¤–æ¨ã€‚
            // ç®€å•å¤„ç†ï¼šå¦‚æœæ²¡æœ‰æ–¹å‘(æ­£å¥½åœ¨ä¸­å¿ƒ)ï¼Œéšæœºé€‰ä¸€ä¸ªæ–¹å‘
            if (absVx < 0.001 && absVy < 0.001) {
                vx = 1; vy = 0;
            }
            
            // è¿™æ˜¯ä¸€ä¸ªå¤æ‚çš„å‡ ä½•é—®é¢˜ï¼ˆåœ†ä¸åœ†è§’çŸ©å½¢çš„ç¢°æ’ï¼‰ã€‚
            // ç®€åŒ–æ–¹æ¡ˆï¼šè¿­ä»£æ³•å‘å¤–æ¨ï¼Œæˆ–è€…ç›´æ¥æ¨åˆ°è¶³å¤Ÿè¿œã€‚
            // è®©æˆ‘ä»¬æ²¿åŸå‘é‡æ–¹å‘æ¨ï¼Œç›´åˆ° |v| è¶³å¤Ÿå¤§ä½¿å¾— distClose >= R_IN
            
            // è®¡ç®—å½“å‰å‘é‡é•¿åº¦
            const currentLen = Math.sqrt(vx*vx + vy*vy);
            if (currentLen === 0) { vx = 1; vy = 0; }
            
            // ç²—ç•¥ä¼°è®¡ï¼šæˆ‘ä»¬éœ€è¦å¢åŠ å¤šå°‘è·ç¦»ï¼Ÿ
            // æœ€è¿‘ç‚¹è·ç¦»ä¸»è¦ç”± (|vx|-h) è´¡çŒ®ã€‚
            // è®¾ç›®æ ‡å‘é‡é•¿åº¦ä¸º L_new = k * currentLen
            // æˆ‘ä»¬éœ€è¦ sqrt( max(0, |vx/len*L| - h)^2 + ... ) = R_IN
            
            // æ­¥è¿›æ³•è§£å†³ (Robust enough for UI interaction)
            let step = 0.5;
            let safety = 0;
            let tempX = x, tempY = y;
            let tempVx = vx, tempVy = vy;
            
            // å°†å•ä½å‘é‡å½’ä¸€åŒ–
            const nx = vx / (currentLen || 1);
            const ny = vy / (currentLen || 1);
            
            while (safety < 100) {
                const curDx = Math.max(0, Math.abs(tempVx) - h);
                const curDy = Math.max(0, Math.abs(tempVy) - h);
                if (curDx*curDx + curDy*curDy >= R_IN * R_IN) {
                    break;
                }
                // å¾€å¤–æ¨
                tempX += nx * step;
                tempY += ny * step;
                tempVx = tempX - 50;
                tempVy = tempY - 50;
                safety++;
            }
            x = tempX;
            y = tempY;
            
            // æ¨å®Œä¹‹åï¼Œå¦‚æœä¸å°å¿ƒè¶…å‡ºäº†å¤–åœ†æ€ä¹ˆåŠï¼Ÿ
            // å†æ¬¡æ£€æŸ¥å¤–åœ†ã€‚å¦‚æœæ—¢è¦æ»¡è¶³å†…åœ†åˆè¦æ»¡è¶³å¤–åœ†ä½†åšä¸åˆ°ï¼ˆæ ·æ–¹å¤ªå¤§ï¼Œç¯å¤ªçª„ï¼‰ï¼Œ
            // åˆ™è¯¥ä½ç½®æ— æ•ˆï¼Œä¿æŒæŸç§ä¸´ç•ŒçŠ¶æ€æˆ–æç¤ºé”™è¯¯ã€‚
            // è¿™é‡Œçš„é€»è¾‘ä¸»è¦æœåŠ¡äºæ‹–æ‹½å¹³æ»‘æ€§ï¼ŒaddQuadrat ä¼šæœ‰å°ºå¯¸é¢„æ£€æŸ¥ã€‚
        }

        return { x, y };
    }

    function addQuadrat(initialX, initialY, clientX, clientY) {
        let sizeM = state.currentPreset === 'custom' ? state.customSize : state.currentPreset;
        const sizePct = (sizeM / state.settings.areaSize) * 100;
        
        // å°ºå¯¸é¢„æ£€æŸ¥ï¼šæ ·æ–¹å¯¹è§’çº¿å¿…é¡»å°äºç¯å®½
        // ç¯å®½ (R_out - R_in) * 2 (ç™¾åˆ†æ¯”ä¸‹) -> (100 - innerPct)/2 æ˜¯å•è¾¹å®½åº¦
        const innerPct = (state.settings.innerSize / state.settings.areaSize) * 100;
        const ringWidth = (100 - innerPct) / 2;
        // è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå®½æ¾çš„æ£€æŸ¥ã€‚ä¸¥æ ¼æ¥è¯´ï¼Œå¦‚æœæ˜¯æ­£æ–¹å½¢ï¼Œéœ€è¦çœ‹èƒ½ä¸èƒ½å¡è¿›å»ã€‚
        // å¦‚æœæ ·æ–¹è¾¹é•¿ > ç¯å®½ï¼Œé‚£è‚¯å®šå¡ä¸è¿›ä»»ä½•è§’åº¦ã€‚
        if (sizePct > ringWidth * 1.5) { // ç¨å¾®æ”¾å®½ä¸€ç‚¹ï¼Œè®©clampå»å¤„ç†è¾¹ç¼˜
             // å®é™…ä¸Šå¦‚æœ sizePct > ringWidth * 1.414ï¼Œæ–œç€ä¹Ÿæ”¾ä¸ä¸‹ã€‚
             // ç®€å•æç¤º
        }

        // å°è¯•è®¡ç®—ä¿®æ­£åçš„ä½ç½®
        let pos = clampPosition(initialX, initialY, sizePct);
        
        // äºŒæ¬¡æ ¡éªŒï¼šæ˜¯å¦çœŸçš„æœ‰æ•ˆï¼Ÿ(clampPosition å¯èƒ½ä¼šå› ä¸ºç©ºé—´ä¸è¶³äº§ç”Ÿæ­»å¾ªç¯æˆ–å¦¥å)
        // æ£€æŸ¥å¤–åœ†
        const h = sizePct/2;
        const farSq = Math.pow(Math.abs(pos.x-50)+h, 2) + Math.pow(Math.abs(pos.y-50)+h, 2);
        if (farSq > 2500.1) {
            showToast(clientX, clientY, "æ ·æ–¹è¿‡å¤§æˆ–ä½ç½®ä¸é€‚ï¼Œæ— æ³•æ”¾å…¥ç¯å¸¦");
            return;
        }
        // æ£€æŸ¥å†…åœ†
        const R_IN = innerPct / 2;
        const closeSq = Math.pow(Math.max(0, Math.abs(pos.x-50)-h), 2) + Math.pow(Math.max(0, Math.abs(pos.y-50)-h), 2);
        if (closeSq < R_IN*R_IN - 0.1) {
            showToast(clientX, clientY, "æ ·æ–¹è¿‡å¤§æˆ–ä½ç½®ä¸é€‚ï¼Œæ— æ³•æ”¾å…¥ç¯å¸¦");
            return;
        }

        let finalX = pos.x;
        let finalY = pos.y;

        // é‡å æ£€æŸ¥
        let overlap = false;
        for (let q of state.quadrats) {
            const dx = Math.abs(finalX - q.x);
            const dy = Math.abs(finalY - q.y);
            const minDist = (sizePct + q.sizePct) / 2;
            
            if (dx < minDist - 0.05 && dy < minDist - 0.05) {
                overlap = true;
                break;
            }
        }

        if (overlap) {
            showToast(clientX, clientY, "å­˜åœ¨é‡å é£é™©,è¯·å°è¯•å…¶ä»–åŒºåŸŸ");
            return;
        }

        createQuadratDOM(finalX, finalY, sizeM, sizePct);
    }

    function createQuadratDOM(x, y, sizeM, sizePct) {
        const id = state.nextId++;
        const el = document.createElement('div');
        el.className = 'quadrat';
        el.style.width = sizePct + '%';
        el.style.height = sizePct + '%';
        el.style.left = x + '%';
        el.style.top = y + '%';
        el.innerText = state.quadrats.length + 1;
        el.dataset.id = id;

        el.addEventListener('mousedown', (e) => handleQuadratClick(e, id));
        el.addEventListener('touchstart', (e) => handleQuadratClick(e, id));

        DOM.simArea.appendChild(el);

        state.quadrats.push({
            id: id,
            x: x, 
            y: y, 
            wM: sizeM,
            hM: sizeM,
            sizePct: sizePct,
            userCount: null,
            element: el
        });
    }

    function handleQuadratClick(e, id) {
        e.stopPropagation();
        const qIndex = state.quadrats.findIndex(q => q.id === id);
        const q = state.quadrats[qIndex];

        if (state.mode === 'counting') {
            openCountModal(q);
            return;
        }

        if (state.mode === 'delete') {
            q.element.remove();
            state.quadrats.splice(qIndex, 1);
            state.quadrats.forEach((item, idx) => item.element.innerText = idx + 1);
            return;
        }

        if (state.mode === 'move') {
            startDrag(e, q);
            return;
        }
    }

    function startDrag(e, q) {
        if(e.cancelable) e.preventDefault();
        const startX = e.clientX || e.touches[0].clientX;
        const startY = e.clientY || e.touches[0].clientY;
        const startLeft = parseFloat(q.element.style.left);
        const startTop = parseFloat(q.element.style.top);
        const rect = DOM.simArea.getBoundingClientRect();

        const onMove = (evt) => {
            const cx = evt.clientX || evt.touches[0].clientX;
            const cy = evt.clientY || evt.touches[0].clientY;
            const dxPct = ((cx - startX) / rect.width) * 100;
            const dyPct = ((cy - startY) / rect.height) * 100;

            let nx = startLeft + dxPct;
            let ny = startTop + dyPct;

            const pos = clampPosition(nx, ny, q.sizePct);
            
            q.element.style.left = pos.x + '%';
            q.element.style.top = pos.y + '%';
            q.tempX = pos.x;
            q.tempY = pos.y;
        };

        const onUp = () => {
            if (q.tempX !== undefined) {
                q.x = q.tempX;
                q.y = q.tempY;
                delete q.tempX;
                delete q.tempY;
            }
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('touchend', onUp);
        };

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
        document.addEventListener('touchmove', onMove, {passive: false});
        document.addEventListener('touchend', onUp);
    }

    function startStatistics() {
        if (state.quadrats.length === 0) {
            alert("è¯·å…ˆæ”¾ç½®æ ·æ–¹");
            return;
        }
        Object.values(DOM.btns).forEach(b => b.classList.remove('highlight'));
        state.mode = 'counting';
        
        DOM.btns.place.disabled = true;
        DOM.btns.move.disabled = true;
        DOM.btns.delete.disabled = true;
        
        document.getElementById('stats-panel').style.display = 'block';
        document.getElementById('mode-info').innerText = "ç»Ÿè®¡æ¨¡å¼: ç‚¹å‡»çº¢æ¡†æ ·æ–¹è¿›è¡Œè®¡æ•°";
        document.getElementById('stats-panel').scrollIntoView({behavior: "smooth"});
    }

    let currentCountingQuadrat = null;

    function openCountModal(quadrat) {
        currentCountingQuadrat = quadrat;
        DOM.modal.style.display = 'flex';
        DOM.modal.querySelector('input').value = quadrat.userCount !== null ? quadrat.userCount : '';
        DOM.modal.querySelector('input').focus();
        renderModalView(quadrat);
    }

    function renderModalView(q) {
        const container = document.getElementById('modal-view');
        container.innerHTML = '';

        const viewScale = 1.2;
        const viewRangePct = q.sizePct * viewScale; 
        const boxSizePx = 200 / viewScale; 

        const box = document.createElement('div');
        box.style.width = boxSizePx + 'px';
        box.style.height = boxSizePx + 'px';
        box.style.border = '2px dashed red';
        box.style.position = 'absolute';
        box.style.top = '50%';
        box.style.left = '50%';
        box.style.transform = 'translate(-50%, -50%)';
        container.appendChild(box);

        const rangeMinX = q.x - viewRangePct / 2;
        const rangeMaxX = q.x + viewRangePct / 2;
        const rangeMinY = q.y - viewRangePct / 2;
        const rangeMaxY = q.y + viewRangePct / 2;

        state.plants.forEach(p => {
            if (p.x >= rangeMinX && p.x <= rangeMaxX && p.y >= rangeMinY && p.y <= rangeMaxY) {
                const relX = (p.x - rangeMinX) / viewRangePct * 200;
                const relY = (p.y - rangeMinY) / viewRangePct * 200;
                
                const dot = document.createElement('div');
                dot.style.width = '12px'; 
                dot.style.height = '12px';
                dot.style.background = '#27ae60'; 
                dot.style.border = '1px solid #555'; 
                dot.style.boxSizing = 'border-box';  
                dot.style.borderRadius = '50%';     
                dot.style.position = 'absolute';
                dot.style.left = relX + 'px';
                dot.style.top = relY + 'px';
                dot.style.transform = 'translate(-50%, -50%)';
                container.appendChild(dot);
            }
        });
    }

    function closeModal() {
        DOM.modal.style.display = 'none';
        currentCountingQuadrat = null;
    }

    function submitCount() {
        const input = DOM.modal.querySelector('input');
        const val = parseInt(input.value);
        if (isNaN(val) || val < 0) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—");
            return;
        }

        currentCountingQuadrat.userCount = val;
        currentCountingQuadrat.element.classList.add('completed');
        
        // æ­¤å¤„ä»…æ ‡è®°å®Œæˆï¼ŒçœŸå®ç»Ÿè®¡åœ¨æœ€åä¸€èµ·åšæˆ–å·²ç»åœ¨ç”Ÿæˆæ—¶ç¡®å®š(ä½†ä¸ºäº†æ•™å­¦æ¼”ç¤ºï¼Œä¸æ˜¾ç¤ºçœŸå®å€¼)
        closeModal();
        checkAllCompleted();
    }

    function checkAllCompleted() {
        if (state.quadrats.every(q => q.userCount !== null)) {
            showFinalResults();
        }
    }

    function showFinalResults() {
        let totalDensity = 0;
        state.quadrats.forEach(q => {
            totalDensity += q.userCount / (q.wM * q.hM);
        });
        const userAvg = totalDensity / state.quadrats.length;

        // è®¡ç®—çœŸå®å¯†åº¦ï¼šæ€»æ¤æ ªæ•° / ç¯å½¢é¢ç§¯
        // é¢ç§¯ = PI * (R_out^2 - R_in^2)
        const radiusOut = state.settings.areaSize / 2;
        const radiusIn = state.settings.innerSize / 2;
        const areaM2 = Math.PI * (radiusOut * radiusOut - radiusIn * radiusIn);
        
        const trueAvg = state.plants.length / areaM2;

        let error = 0;
        if (trueAvg !== 0) error = Math.abs(userAvg - trueAvg) / trueAvg * 100;
        else if (userAvg !== 0) error = 100;

        document.getElementById('result-display').style.display = 'block';
        document.getElementById('user-density').innerText = userAvg.toFixed(4);
        document.getElementById('true-density').innerText = trueAvg.toFixed(4);
        document.getElementById('error-rate').innerText = error.toFixed(2);
    }

    function resetUIState() {
        DOM.simArea.innerHTML = '';
        document.getElementById('stats-panel').style.display = 'none';
        document.getElementById('result-display').style.display = 'none';
        
        DOM.btns.place.disabled = false;
        DOM.btns.move.disabled = false;
        DOM.btns.delete.disabled = false;
        Object.values(DOM.btns).forEach(b => b.classList.remove('highlight'));
        document.getElementById('mode-info').innerText = "è¯·é€‰æ‹©æ“ä½œæ¨¡å¼";
    }

    init();
</script>
</body>
</html>