<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤šåœ°å½¢æ ·æ–¹æ³•æ¨¡æ‹Ÿ v2.1 (ç¯å½¢å¢å¼ºç‰ˆ)</title>
    <style>
        /* --- CSS å˜é‡å®šä¹‰ (æ”¯æŒæ·±è‰²æ¨¡å¼) --- */
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --highlight-color: #e74c3c;
            --bg-color: #f5f6fa;
            --panel-bg: #ffffff;
            --border-color: #dcdde1;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --input-bg: #ffffff;
            --modal-overlay: rgba(0,0,0,0.5);
            --card-bg: #ffffff;
            --shadow: rgba(0,0,0,0.1);
        }

        /* æ·±è‰²æ¨¡å¼é€‚é… */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #ecf0f1;
                --accent-color: #5dade2;
                --highlight-color: #e74c3c;
                --bg-color: #1a1a1a;
                --panel-bg: #2d2d2d;
                --border-color: #444;
                --text-main: #ecf0f1;
                --text-sub: #bdc3c7;
                --input-bg: #3d3d3d;
                --modal-overlay: rgba(0,0,0,0.8);
                --card-bg: #383838;
                --shadow: rgba(0,0,0,0.5);
            }
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
            height: 100vh;
            display: flex;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* å¸ƒå±€: å·¦æ§å³æ¨¡ */
        @media (min-width: 768px) {
            body { flex-direction: row; }
            #control-panel {
                width: 400px; 
                border-right: 1px solid var(--border-color);
                order: 1;
            }
            #simulation-container {
                flex: 1;
                order: 2;
            }
        }

        /* æ‰‹æœº: ä¸Šæ¨¡ä¸‹æ§ */
        @media (max-width: 767px) {
            body { flex-direction: column; }
            #simulation-container {
                flex: 1;
                order: 1; 
            }
            #control-panel {
                height: 50%; 
                order: 2;
                border-top: 1px solid var(--border-color);
                overflow-y: auto;
            }
        }

        #simulation-container {
            position: relative;
            background-color: var(--bg-color);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        /* æ¨¡æ‹ŸåŒºåŸŸå®¹å™¨ */
        #simulation-area {
            width: 100%;
            max-width: 80vh; 
            /* é»˜è®¤ä¸ºé€æ˜ï¼ŒèƒŒæ™¯ç”± SVG ç»˜åˆ¶ */
            background-color: transparent; 
            position: relative;
            /* box-shadow: 0 0 15px var(--shadow); */
            transition: all 0.3s ease-in-out;
        }

        /* åœ°å½¢èƒŒæ™¯å±‚ */
        #terrain-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none; /* å…è®¸ç‚¹å‡»ç©¿é€ */
        }
        .terrain-fill {
            fill: var(--panel-bg);
            stroke: var(--text-main);
            stroke-width: 1;
            vector-effect: non-scaling-stroke;
        }

        .plant-anchor {
            position: absolute;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .plant-svg { overflow: visible; }

        /* å‘¼å¸åŠ¨ç”»ï¼šç”¨äºé«˜äº®ç›®æ ‡æ¤ç‰© */
        @keyframes target-pulse {
            0% { transform: scale(1); filter: drop-shadow(0 0 2px var(--accent-color)); }
            50% { transform: scale(1.3); filter: drop-shadow(0 0 5px var(--accent-color)); }
            100% { transform: scale(1); filter: drop-shadow(0 0 2px var(--accent-color)); }
        }
        .plant-highlight {
            animation: target-pulse 1.5s infinite ease-in-out;
            z-index: 100;
        }
        .plant-dimmed {
            opacity: 0.2;
            filter: grayscale(80%);
        }

        .quadrat {
            position: absolute;
            border: 2px dashed #ff4757;
            background-color: rgba(255, 71, 87, 0.1);
            z-index: 10;
            cursor: grab;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            color: #ff4757;
            font-weight: bold;
            transform: translate(-50%, -50%); 
        }
        .quadrat.completed {
            border-color: #2ecc71;
            background-color: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .toast-bubble {
            position: fixed;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none; 
            z-index: 9999;
            transform: translate(-50%, -100%); 
            margin-top: -10px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .toast-bubble.show { opacity: 1; }

        #control-panel {
            background-color: var(--panel-bg);
            display: flex;
            flex-direction: column;
            color: var(--text-main);
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-color);
            flex-shrink: 0;
        }
        .tab-btn {
            flex: 1;
            padding: 12px;
            background: var(--bg-color);
            border: none;
            font-weight: bold;
            color: var(--text-sub);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: var(--panel-bg);
            color: var(--accent-color);
            border-bottom: 2px solid var(--accent-color);
        }
        .tab-content { display: none; padding: 15px; flex: 1; overflow-y: auto; }
        .tab-content.active { display: block; }

        .section { margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .section-title { font-weight: bold; margin-bottom: 8px; color: var(--accent-color); font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        
        .preset-scroll { display: flex; gap: 8px; margin-bottom: 8px; overflow-x: auto; }
        .preset-item {
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            background: var(--input-bg);
            color: var(--text-main);
            font-size: 13px;
            white-space: nowrap;
        }
        .preset-item.selected {
            border-color: var(--accent-color);
            background-color: var(--bg-color);
            color: var(--accent-color);
            font-weight: bold;
        }

        .btn {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-main);
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            transition: all 0.2s;
        }
        .action-group { display: flex; gap: 8px; margin-bottom: 10px; }
        .btn.highlight { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
        .btn-danger.highlight { background-color: var(--highlight-color); border-color: var(--highlight-color); color: white; }
        .btn-primary { background-color: var(--primary-color); color: var(--bg-color); border: none; font-size: 14px; margin-top: 5px; }
        .btn-success { background-color: #27ae60; color: white; border: none; margin-top: 15px; }
        .btn-sm { width: auto; padding: 4px 8px; font-size: 12px; }

        @media (prefers-color-scheme: dark) {
            .btn-primary { background-color: var(--accent-color); color: white; }
        }

        .info-display { background: var(--bg-color); padding: 8px; border-radius: 4px; font-size: 12px; color: var(--text-sub); line-height: 1.4; margin-bottom: 8px; border: 1px solid var(--border-color); }
        .result-box { background: var(--card-bg); border: 1px solid var(--border-color); padding: 10px; margin-top: 10px; font-size: 13px; border-radius: 4px; }
        .result-line { display: flex; justify-content: space-between; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px dashed var(--border-color); }

        .setting-item { margin-bottom: 10px; }
        .setting-item label { display: block; margin-bottom: 5px; font-size: 13px; color: var(--text-main); }
        input[type="text"], input[type="number"], select {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 13px;
            width: 100%;
            background: var(--input-bg);
            color: var(--text-main);
        }

        .species-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-left: 4px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            position: relative;
        }
        .species-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .species-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--modal-overlay); display: none;
            justify-content: center; align-items: center; z-index: 2000;
            backdrop-filter: blur(3px);
        }
        .modal {
            background: var(--panel-bg); 
            padding: 25px; 
            border-radius: 12px; 
            width: 650px; 
            max-width: 95vw;
            max-height: 95vh;
            display: flex; 
            flex-direction: column; 
            gap: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            color: var(--text-main);
        }
        .quadrat-view-container {
            width: 500px; 
            height: 500px; 
            max-width: 100%;
            aspect-ratio: 1/1;
            margin: 0 auto;
            position: relative; 
            background: var(--bg-color); 
            border: 2px solid var(--border-color); 
            overflow: hidden;
            border-radius: 8px;
        }

        @media (max-width: 600px) {
            .modal { width: 95vw; padding: 15px; }
            .quadrat-view-container { width: 100%; height: auto; aspect-ratio: 1/1; }
        }

        #target-select-wrapper {
            background: rgba(52, 152, 219, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            border: 1px solid var(--accent-color);
        }

        /* ç¯å½¢ç‰¹å®šè®¾ç½®å®¹å™¨ */
        #ring-settings-panel {
            background: var(--input-bg);
            border: 1px dashed var(--border-color);
            padding: 10px;
            border-radius: 4px;
            margin-top: 5px;
            display: none;
        }
    </style>
</head>
<body>

    <div id="toast-bubble" class="toast-bubble">æç¤ºä¿¡æ¯</div>

    <div id="control-panel">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('main')">ä¸»è¦åŠŸèƒ½</button>
            <button class="tab-btn" onclick="switchTab('settings')">å®éªŒè®¾ç½®</button>
        </div>

        <div id="tab-main" class="tab-content active">
            <div class="section">
                <div class="section-title">1. æ ·æ–¹é¢„è®¾</div>
                <div class="preset-scroll">
                    <div class="preset-item selected" onclick="selectPreset(1, this)">1m</div>
                    <div class="preset-item" onclick="selectPreset(2, this)">2m</div>
                    <div class="preset-item" onclick="selectPreset(5, this)">5m</div>
                    <div class="preset-item" onclick="selectPreset('custom', this)">è‡ªå®šä¹‰</div>
                </div>
                <div id="preset-info" class="info-display">å½“å‰é€‰æ‹©: è¾¹é•¿ 1m</div>
                <div id="custom-input-div" style="display:none; align-items:center; gap:10px; margin-bottom:5px; font-size:13px;">
                    <label>è¾¹é•¿(m):</label>
                    <input type="number" id="custom-size-input" value="10" min="1" max="1000" style="width:80px;">
                </div>
            </div>

            <div class="section">
                <div class="section-title">2. æ“ä½œæ¨¡å¼</div>
                <div class="action-group">
                    <button class="btn" id="btn-place" onclick="setMode('place')">æ”¾ç½®</button>
                    <button class="btn" id="btn-move" onclick="setMode('move')">ç§»åŠ¨</button>
                    <button class="btn btn-danger" id="btn-delete" onclick="setMode('delete')">åˆ é™¤</button>
                </div>
                <div class="info-display" id="mode-info">è¯·é€‰æ‹©æ“ä½œæ¨¡å¼</div>
            </div>

            <div class="section">
                <div class="section-title">3. ç»Ÿè®¡åˆ†æ</div>
                
                <div id="target-select-wrapper">
                    <label style="font-weight:bold; font-size:13px; color:var(--text-main);">ğŸ¯ é€‰æ‹©ç›®æ ‡ç»Ÿè®¡ç‰©ç§:</label>
                    <select id="main-target-species" style="margin-top:5px; font-weight:bold;">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </select>
                    <div style="font-size:11px; color:var(--text-sub); margin-top:4px;">* ç»Ÿè®¡æ—¶éç›®æ ‡æ¤ç‰©ä¼šè‡ªåŠ¨å˜æš—</div>
                </div>

                <button class="btn btn-primary" id="btn-start-stats" onclick="startStatistics()">å¼€å§‹ç»Ÿè®¡æ¨¡å¼</button>
                
                <div id="stats-panel" style="display:none; margin-top: 15px;">
                    <div class="info-display">
                        ç»Ÿè®¡ä¸­... è¯·ç‚¹å‡»çº¢è‰²æ ·æ–¹å½•å…¥ [<span id="stats-target-name">--</span>] çš„æ•°é‡ã€‚<br>
                    </div>
                    
                    <div id="result-display" style="display:none;">
                        <div class="result-box" style="border-left: 4px solid var(--accent-color);">
                            <div class="section-title">ç»Ÿè®¡ç»“æœæŠ¥å‘Š</div>
                            <div class="result-line"><span>ç›®æ ‡ç‰©ç§:</span> <strong id="res-name">--</strong></div>
                            <div class="result-line"><span>çœŸå®ç§ç¾¤å¯†åº¦:</span> <strong id="true-density">--</strong> æ ª/mÂ²</div>
                            <div class="result-line"><span>æ‚¨çš„ä¼°ç®—å¯†åº¦:</span> <strong id="user-density">--</strong> æ ª/mÂ²</div>
                            <div class="result-line"><span>ç›¸å¯¹è¯¯å·®:</span> <strong id="error-rate" style="color:var(--highlight-color)">--</strong>%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="section">
                <div class="section-title">åœ°å½¢ä¸ç¯å¢ƒå‚æ•°</div>
                <div class="setting-item">
                    <label>åœ°å½¢å½¢çŠ¶:</label>
                    <select id="setting-shape" onchange="toggleRingSettings(); updateSettings()">
                        <option value="square">æ­£æ–¹å½¢ (1:1)</option>
                        <option value="rect169">é•¿æ–¹å½¢ (16:9)</option>
                        <option value="circle">åœ†å½¢</option>
                        <option value="ring">ç¯å½¢ / æ‰‡å½¢</option>
                    </select>
                </div>

                <!-- ç¯å½¢/æ‰‡å½¢ä¸“å±è®¾ç½® -->
                <div id="ring-settings-panel">
                    <div class="setting-item">
                        <label>å†…å¾„ (ç±³, < å¤–å¾„):</label>
                        <input type="number" id="setting-ring-inner" value="5" min="0" onchange="updateSettings()">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <div class="setting-item" style="flex:1;">
                            <label>èµ·å§‹è§’åº¦ (Â°):</label>
                            <input type="number" id="setting-ring-start" value="0" min="0" max="360" onchange="updateSettings()">
                        </div>
                        <div class="setting-item" style="flex:1;">
                            <label>ç»“æŸè§’åº¦ (Â°):</label>
                            <input type="number" id="setting-ring-end" value="360" min="0" max="360" onchange="updateSettings()">
                        </div>
                    </div>
                    <div style="font-size:11px; color:var(--text-sub);">
                        * 0Â° ä¸ºæ­£ä¸Šæ–¹ï¼Œé¡ºæ—¶é’ˆæ–¹å‘ã€‚
                    </div>
                </div>

                <div class="setting-item" style="margin-top:10px;">
                    <label>å¤–å¾„ / ä¸»è¾¹é•¿ (m):</label>
                    <input type="number" id="setting-area-size" value="15" min="1" max="1000" onchange="updateSettings()">
                    <div style="font-size:11px; color:var(--text-sub); margin-top:3px;">
                        *å¯¹äºåœ†å½¢/ç¯å½¢ï¼Œæ­¤æ•°å€¼ä¸ºå¤–å¾„(ç›´å¾„)ã€‚
                    </div>
                </div>
                <div class="setting-item">
                    <label>éšæœºç§å­ (Seed):</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="setting-seed" placeholder="ä»»æ„å­—ç¬¦" value="BioLab" style="flex:1;" onchange="updateSettings()">
                        <button class="btn btn-sm" onclick="randomizeSeed()">ğŸ²</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">
                    <span>ç‰©ç§åˆ—è¡¨ (Species)</span>
                    <button class="btn btn-sm btn-primary" style="width:auto;" onclick="addNewSpecies()">+ æ·»åŠ </button>
                </div>
                <div id="species-list-container"></div>
            </div>

            <button class="btn btn-primary" onclick="resetSimulation()">åº”ç”¨è®¾ç½®å¹¶é‡ç½®</button>
            <button class="btn btn-success" onclick="shareConfiguration()">ğŸ”— ç”Ÿæˆåˆ†äº«é“¾æ¥</button>
        </div>
    </div>

    <div id="simulation-container">
        <!-- æ¨¡æ‹ŸåŒºåŸŸ -->
        <div id="simulation-area">
            <!-- åœ°å½¢èƒŒæ™¯ç»˜åˆ¶å±‚ -->
            <svg id="terrain-layer" viewBox="0 0 100 100" preserveAspectRatio="none">
                <path id="terrain-path" class="terrain-fill" d="" />
            </svg>
        </div>
        
        <!-- æ¯”ä¾‹å°ºä¿¡æ¯ -->
        <div style="position: absolute; bottom: 5px; right: 10px; font-size: 12px; color: #555; background:rgba(255,255,255,0.8); padding:4px 8px; border-radius:3px; box-shadow:0 1px 3px rgba(0,0,0,0.1); pointer-events: none;">
            å°ºå¯¸: <span id="area-scale-label">15</span>m <span id="area-shape-label"></span>
        </div>
    </div>

    <!-- è®¡æ•°å½•å…¥æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="count-modal">
        <div class="modal">
            <div class="modal-header" style="text-align: center; padding-bottom:10px; border-bottom:1px solid var(--border-color);">
                <span style="font-size:18px; font-weight:bold;">æ ·æ–¹è®¡æ•° (ä¿¯è§†å›¾)</span>
                <div style="font-size: 13px; color: var(--text-sub); margin-top:5px;">
                    è¯·ç»Ÿè®¡: <span id="modal-target-name" style="color:var(--highlight-color); font-weight:bold; font-size:15px;">--</span>
                    <span style="font-size:11px; margin-left:5px;">(å…¶ä»–æ¤ç‰©å·²è‡ªåŠ¨å˜æš—)</span>
                </div>
            </div>
            
            <div class="quadrat-view-container" id="modal-view"></div>
            
            <div>
                <label style="font-size:14px; font-weight:bold;">å½•å…¥æ•°é‡:</label>
                <input type="number" id="modal-input-count" style="width: 100%; margin-top: 5px; padding: 12px; font-size:18px; text-align:center;">
            </div>
            <div class="modal-actions" style="display:flex; gap:15px;">
                <button class="btn" style="flex:1; height:45px;" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn highlight" style="flex:2; height:45px; font-size:16px;" onclick="submitCount()">ç¡®è®¤å½•å…¥</button>
            </div>
        </div>
    </div>

<script>
    // é»˜è®¤ç‰©ç§é…ç½®
    const DEFAULT_SPECIES = [
        { id: 's1', name: 'è’²å…¬è‹±', count: 120, size: 8, shape: 'circle', style: 'solid', color: '#f1c40f', dispersion: 1.0 },
        { id: 's2', name: 'è½¦å‰è‰', count: 80, size: 12, shape: 'triangle', style: 'hollow', color: '#2ecc71', dispersion: 0.3 }
    ];

    const state = {
        mode: null, 
        settings: { 
            areaSize: 15,  // å¤–å¾„æˆ–é•¿è¾¹
            shape: 'square', // square, rect169, circle, ring
            ringInner: 5,   // ç¯å½¢å†…å¾„ (m)
            ringStart: 0,   // ç¯å½¢èµ·å§‹è§’åº¦
            ringEnd: 360,   // ç¯å½¢ç»“æŸè§’åº¦
            seed: "BioLab",
            species: JSON.parse(JSON.stringify(DEFAULT_SPECIES))
        },
        targetSpeciesId: null, // ç»Ÿè®¡ç›®æ ‡
        currentPreset: 1, 
        customSize: 10,
        plants: [], 
        quadrats: [],
        nextId: 1
    };

    const DOM = {
        simArea: document.getElementById('simulation-area'),
        terrainPath: document.getElementById('terrain-path'),
        modal: document.getElementById('count-modal'),
        toast: document.getElementById('toast-bubble'),
        speciesContainer: document.getElementById('species-list-container'),
        targetSelect: document.getElementById('main-target-species'),
        ringPanel: document.getElementById('ring-settings-panel'),
        btns: {
            place: document.getElementById('btn-place'),
            move: document.getElementById('btn-move'),
            delete: document.getElementById('btn-delete')
        }
    };

    // --- éšæœºæ•°ç”Ÿæˆå™¨ ---
    let seedState = 0;
    function initSeed(str) {
        let h = 2166136261 >>> 0;
        for (let i = 0; i < str.length; i++) {
            h = Math.imul(h ^ str.charCodeAt(i), 16777619);
        }
        seedState = h;
    }
    function seededRandom() {
        seedState += 0x6D2B79F5;
        let t = seedState;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }

    // --- åˆå§‹åŒ– ---
    function init() {
        loadSettingsFromURL();
        toggleRingSettings();
        renderSpeciesSettings();
        resetSimulation();
        setupEventListeners();
    }

    // --- è®¾ç½®é€»è¾‘ ---
    
    function toggleRingSettings() {
        const shape = document.getElementById('setting-shape').value;
        if (shape === 'ring') {
            DOM.ringPanel.style.display = 'block';
        } else {
            DOM.ringPanel.style.display = 'none';
        }
    }

    function renderSpeciesSettings() {
        DOM.speciesContainer.innerHTML = '';
        state.settings.species.forEach((sp, index) => {
            const card = document.createElement('div');
            card.className = 'species-card';
            card.style.borderLeftColor = sp.color;
            
            card.innerHTML = `
                <div class="species-header">
                    <input type="text" value="${sp.name}" onchange="updateSpeciesParam('${sp.id}', 'name', this.value)" style="width:60%; font-weight:bold;">
                    <button class="btn btn-sm btn-danger highlight" style="width:auto;" onclick="removeSpecies('${sp.id}')">åˆ é™¤</button>
                </div>
                <div class="species-grid">
                    <div>
                        <label>æ•°é‡:</label>
                        <input type="number" value="${sp.count}" min="1" max="2000" onchange="updateSpeciesParam('${sp.id}', 'count', parseInt(this.value))">
                    </div>
                    <div>
                        <label>å¤§å°(px):</label>
                        <input type="number" value="${sp.size}" min="2" max="50" onchange="updateSpeciesParam('${sp.id}', 'size', parseInt(this.value))">
                    </div>
                    <div>
                        <label>å½¢çŠ¶:</label>
                        <select onchange="updateSpeciesParam('${sp.id}', 'shape', this.value)">
                            <option value="circle" ${sp.shape=='circle'?'selected':''}>åœ†å½¢</option>
                            <option value="square" ${sp.shape=='square'?'selected':''}>æ­£æ–¹å½¢</option>
                            <option value="triangle" ${sp.shape=='triangle'?'selected':''}>ä¸‰è§’å½¢</option>
                            <option value="rhombus" ${sp.shape=='rhombus'?'selected':''}>è±å½¢</option>
                            <option value="star" ${sp.shape=='star'?'selected':''}>æ˜Ÿå½¢</option>
                        </select>
                    </div>
                    <div>
                        <label>é£æ ¼:</label>
                        <select onchange="updateSpeciesParam('${sp.id}', 'style', this.value)">
                            <option value="solid" ${sp.style=='solid'?'selected':''}>å®å¿ƒ</option>
                            <option value="hollow" ${sp.style=='hollow'?'selected':''}>ç©ºå¿ƒ</option>
                        </select>
                    </div>
                    <div style="grid-column: span 2; display:flex; gap:10px; align-items:center;">
                        <label style="margin:0;">é¢œè‰²:</label>
                        <input type="color" value="${sp.color}" onchange="updateSpeciesParam('${sp.id}', 'color', this.value)" style="flex:1; height:30px;">
                    </div>
                    <div style="grid-column: span 2;">
                        <label>åˆ†å¸ƒç¦»æ•£åº¦ (0èš-1æ•£): ${sp.dispersion}</label>
                        <input type="range" min="0" max="1" step="0.1" value="${sp.dispersion}" 
                            onchange="updateSpeciesParam('${sp.id}', 'dispersion', parseFloat(this.value))"
                            style="width:100%">
                    </div>
                </div>
            `;
            DOM.speciesContainer.appendChild(card);
        });
        updateMainTargetSelect();
    }

    function addNewSpecies() {
        const colors = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6'];
        const shapes = ['circle', 'square', 'triangle', 'star'];
        const id = 's' + Date.now(); 
        const randColor = colors[state.settings.species.length % colors.length];
        const randShape = shapes[state.settings.species.length % shapes.length];
        
        state.settings.species.push({
            id: id,
            name: `æ–°ç‰©ç§ ${state.settings.species.length + 1}`,
            count: 50,
            size: 8,
            shape: randShape,
            style: 'solid',
            color: randColor,
            dispersion: 0.8
        });
        renderSpeciesSettings();
    }

    function removeSpecies(id) {
        if (state.settings.species.length <= 1) {
            alert("è‡³å°‘ä¿ç•™ä¸€ç§æ¤ç‰©ï¼");
            return;
        }
        state.settings.species = state.settings.species.filter(s => s.id !== id);
        renderSpeciesSettings();
    }

    function updateSpeciesParam(id, key, val) {
        const sp = state.settings.species.find(s => s.id === id);
        if(sp) sp[key] = val;
    }

    function updateMainTargetSelect() {
        DOM.targetSelect.innerHTML = '';
        state.settings.species.forEach(sp => {
            const opt = document.createElement('option');
            opt.value = sp.id;
            opt.innerText = sp.name;
            opt.style.color = sp.color; 
            DOM.targetSelect.appendChild(opt);
        });
    }

    function updateSettings() {
        let size = parseInt(document.getElementById('setting-area-size').value);
        if(size < 1) size = 1; if(size > 1000) size = 1000;
        
        state.settings.areaSize = size;
        state.settings.seed = document.getElementById('setting-seed').value;
        state.settings.shape = document.getElementById('setting-shape').value;
        
        // ç¯å½¢å‚æ•°è¯»å–
        state.settings.ringInner = parseFloat(document.getElementById('setting-ring-inner').value) || 0;
        state.settings.ringStart = parseFloat(document.getElementById('setting-ring-start').value) || 0;
        state.settings.ringEnd = parseFloat(document.getElementById('setting-ring-end').value) || 360;

        // ç®€å•æ ¡éªŒ
        if (state.settings.ringInner >= state.settings.areaSize) {
            // åªæ˜¯è­¦å‘Šï¼Œæ•°å€¼æš‚ä¸å¼ºåˆ¶é‡ç½®ï¼Œé˜²æ­¢è¾“å…¥è¿‡ç¨‹è¢«æ‰“æ–­
        }

        // æ›´æ–°æ˜¾ç¤ºæ ‡ç­¾
        let h = size;
        if(state.settings.shape === 'rect169') h = (size * 9 / 16).toFixed(1);
        
        document.getElementById('area-scale-label').innerText = size;
        const displayH = (state.settings.shape === 'circle' || state.settings.shape === 'ring') ? size : h;
        // å¦‚æœæ˜¯ç¯å½¢æˆ–åœ†å½¢ï¼Œåªæ˜¾ç¤ºç›´å¾„
        const labelContainer = document.getElementById('area-scale-label-2').parentNode;
        labelContainer.innerHTML = `å°ºå¯¸: <span id="area-scale-label">${size}</span>m ${state.settings.shape.includes('rect')||state.settings.shape==='square' ? `x <span>${displayH}</span>m` : '(ç›´å¾„)'} <span id="area-shape-label"></span>`;

        const shapeNames = { 'square': '(æ­£æ–¹å½¢)', 'rect169': '(16:9)', 'circle': '(åœ†å½¢)', 'ring': '(ç¯å½¢/æ‰‡å½¢)' };
        document.getElementById('area-shape-label').innerText = shapeNames[state.settings.shape];
    }

    function randomizeSeed() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let res = '';
        for(let i=0; i<6; i++) res += chars.charAt(Math.floor(Math.random() * chars.length));
        document.getElementById('setting-seed').value = res;
        updateSettings();
    }

    function shareConfiguration() {
        const config = {
            a: state.settings.areaSize,
            s: state.settings.seed,
            sh: state.settings.shape,
            sp: state.settings.species,
            ri: state.settings.ringInner,
            rs: state.settings.ringStart,
            re: state.settings.ringEnd
        };
        const jsonStr = JSON.stringify(config);
        const encoded = encodeURIComponent(jsonStr);
        const url = `${window.location.origin}${window.location.pathname}?cfg=${encoded}`;
        
        navigator.clipboard.writeText(url).then(() => {
            showToast(window.innerWidth/2, window.innerHeight - 50, "âœ… é“¾æ¥å·²å¤åˆ¶ï¼");
        }).catch(() => {
            prompt("å¤åˆ¶é“¾æ¥:", url);
        });
    }

    function loadSettingsFromURL() {
        const params = new URLSearchParams(window.location.search);
        if(params.has('cfg')) {
            try {
                const config = JSON.parse(decodeURIComponent(params.get('cfg')));
                if(config.a) state.settings.areaSize = config.a;
                if(config.s) state.settings.seed = config.s;
                if(config.sh) state.settings.shape = config.sh;
                if(config.sp && Array.isArray(config.sp)) state.settings.species = config.sp;
                if(config.ri !== undefined) state.settings.ringInner = config.ri;
                if(config.rs !== undefined) state.settings.ringStart = config.rs;
                if(config.re !== undefined) state.settings.ringEnd = config.re;
            } catch(e) {
                console.error("é…ç½®è§£æå¤±è´¥", e);
            }
        }
        document.getElementById('setting-area-size').value = state.settings.areaSize;
        document.getElementById('setting-seed').value = state.settings.seed;
        document.getElementById('setting-shape').value = state.settings.shape || 'square';
        document.getElementById('setting-ring-inner').value = state.settings.ringInner;
        document.getElementById('setting-ring-start').value = state.settings.ringStart;
        document.getElementById('setting-ring-end').value = state.settings.ringEnd;
    }

    // --- æ¨¡æ‹Ÿç”Ÿæˆé€»è¾‘ ---

    function resetSimulation() {
        updateSettings();
        initSeed(state.settings.seed);

        // è®¾ç½®å®¹å™¨æ¯”ä¾‹
        if(state.settings.shape === 'rect169') {
            DOM.simArea.style.aspectRatio = "16/9";
        } else {
            DOM.simArea.style.aspectRatio = "1/1";
        }
        
        // ç»˜åˆ¶åœ°å½¢èƒŒæ™¯ (SVG)
        drawTerrainBackground();

        state.quadrats.forEach(q => q.element.remove());
        state.quadrats = [];
        state.mode = null;
        resetUIState();
        generatePlants();
        switchTab('main');
        updateMainTargetSelect(); 
    }

    function drawTerrainBackground() {
        const shape = state.settings.shape;
        let d = "";
        
        if (shape === 'square') {
            d = "M 0 0 L 100 0 L 100 100 L 0 100 Z";
        } else if (shape === 'rect169') {
            d = "M 0 0 L 100 0 L 100 100 L 0 100 Z";
        } else if (shape === 'circle') {
            d = "M 50 50 m -50 0 a 50 50 0 1 0 100 0 a 50 50 0 1 0 -100 0 Z";
        } else if (shape === 'ring') {
            // ç»˜åˆ¶æ‰‡å½¢æˆ–åœ†ç¯è·¯å¾„
            const cx = 50, cy = 50, rOut = 50;
            const rInRaw = (state.settings.ringInner / state.settings.areaSize) * 50;
            const rIn = Math.min(rInRaw, 49.9); // é˜²æ­¢å®Œå…¨é‡åˆå¯¼è‡´è®¡ç®—é”™è¯¯

            const startDeg = state.settings.ringStart - 90; // 0åº¦åœ¨æ­£ä¸Šæ–¹ï¼ŒSVGé»˜è®¤0åœ¨å³ä¾§ï¼Œéœ€å‡90
            const endDeg = state.settings.ringEnd - 90;
            
            // å°†è§’åº¦è½¬æ¢ä¸ºå¼§åº¦
            const toRad = deg => deg * Math.PI / 180;
            const startRad = toRad(startDeg);
            const endRad = toRad(endDeg);

            // è®¡ç®—åæ ‡
            const x1 = cx + rOut * Math.cos(startRad);
            const y1 = cy + rOut * Math.sin(startRad);
            const x2 = cx + rOut * Math.cos(endRad);
            const y2 = cy + rOut * Math.sin(endRad);
            
            const x3 = cx + rIn * Math.cos(endRad);
            const y3 = cy + rIn * Math.sin(endRad);
            const x4 = cx + rIn * Math.cos(startRad);
            const y4 = cy + rIn * Math.sin(startRad);

            // åˆ¤è¯»æ˜¯å¦æ˜¯å¤§åœ†å¼§ (>180åº¦)
            const diffDeg = state.settings.ringEnd - state.settings.ringStart;
            // å¤„ç†è·¨è¶Š0åº¦çš„æƒ…å†µ (å¦‚350åˆ°10åº¦) - è¿™é‡Œçš„è¾“å…¥é€»è¾‘å‡è®¾ start < endï¼Œæˆ–è€…ç”¨æˆ·è¾“å…¥èŒƒå›´ã€‚
            // ç®€å•èµ·è§ï¼Œå¦‚æœ start > endï¼Œåˆ™è§†ä¸ºé”™è¯¯æˆ–ä¸ç»˜åˆ¶ï¼Œæˆ–è€…äº¤æ¢ã€‚
            // å‡è®¾ç”¨æˆ·è¾“å…¥çš„èŒƒå›´æœ‰æ•ˆã€‚
            const largeArc = (endDeg - startDeg) > 180 ? 1 : 0;
            const sweep = 1; // é¡ºæ—¶é’ˆ

            // å¦‚æœæ˜¯360åº¦æ•´åœ†
            if (Math.abs(diffDeg) >= 359.9) {
                 d = `M 50 50 m -50 0 a 50 50 0 1 0 100 0 a 50 50 0 1 0 -100 0 Z`; // å¤–åœ†
                 if(rIn > 0) {
                     // å¤åˆè·¯å¾„æŒ–ç©ºå†…åœ† (SVG fill-ruleé»˜è®¤nonzeroï¼Œéœ€æ³¨æ„æ–¹å‘ï¼Œæˆ–è€…ç”¨Måˆ†å¼€ç”»)
                     // ç®€å•åšæ³•ï¼šç”»ä¸€ä¸ªç¯ã€‚æˆ–è€…ä¸¤ä¸ªåœ†ï¼Œä½†è¦åå‘ç”»å†…åœ†ã€‚
                     // è¿™é‡Œä½¿ç”¨ path ç»„åˆï¼šå¤–åœ†(é¡º) + å†…åœ†(é€†)
                     d = `M 50 5 m -${rOut} 45 a ${rOut} ${rOut} 0 1 0 ${rOut*2} 0 a ${rOut} ${rOut} 0 1 0 -${rOut*2} 0 Z 
                          M 50 ${50-rIn} a ${rIn} ${rIn} 0 1 1 0 ${rIn*2} a ${rIn} ${rIn} 0 1 1 0 -${rIn*2} Z`;
                 }
            } else {
                // æ‰‡å½¢ç¯
                d = `M ${x1} ${y1} A ${rOut} ${rOut} 0 ${largeArc} ${sweep} ${x2} ${y2} L ${x3} ${y3} A ${rIn} ${rIn} 0 ${largeArc} 0 ${x4} ${y4} Z`;
            }
        }

        DOM.terrainPath.setAttribute('d', d);
    }

    function generatePlants() {
        // æ¸…é™¤æ—§æ¤ç‰©å…ƒç´ ä½†ä¿ç•™åœ°å½¢å±‚
        const plants = DOM.simArea.querySelectorAll('.plant-anchor');
        plants.forEach(p => p.remove());
        
        state.plants = [];
        const fragment = document.createDocumentFragment();
        const rand = seededRandom; 
        const isCircle = state.settings.shape === 'circle';
        const isRing = state.settings.shape === 'ring';

        state.settings.species.forEach(sp => {
            let generatedCount = 0;
            let attempts = 0;
            
            // ç¯å½¢å‚æ•°é¢„è®¡ç®—
            const rOut = 50;
            const rIn = isRing ? (state.settings.ringInner / state.settings.areaSize) * 50 : 0;
            const startRad = isRing ? (state.settings.ringStart - 90) * Math.PI / 180 : 0;
            const endRad = isRing ? (state.settings.ringEnd - 90) * Math.PI / 180 : 2 * Math.PI;
            const angleSpan = endRad - startRad;

            while(generatedCount < sp.count && attempts < sp.count * 20) {
                attempts++;
                let x, y;
                
                if (isRing) {
                    // ç¯å½¢/æ‰‡å½¢ä½¿ç”¨æåæ ‡ç”Ÿæˆï¼Œç¡®ä¿åˆ†å¸ƒå‡åŒ€ä¸”å¿…é¡»åœ¨åŒºåŸŸå†…
                    // åŠå¾„ç”Ÿæˆéœ€è¦å¼€æ ¹å·ä»¥ä¿è¯é¢ç§¯å‡åŒ€åˆ†å¸ƒï¼šr = sqrt(rand*(R^2 - r^2) + r^2)
                    const rRand = rand();
                    const rVal = Math.sqrt(rRand * (rOut*rOut - rIn*rIn) + rIn*rIn);
                    
                    // è§’åº¦ç”Ÿæˆ
                    let theta = startRad + rand() * angleSpan;
                    
                    x = 50 + rVal * Math.cos(theta);
                    y = 50 + rVal * Math.sin(theta);
                } else {
                    // æ ‡å‡†çŸ©å½¢ç”Ÿæˆ
                    x = rand() * 100;
                    y = rand() * 100;

                    // åœ†å½¢è£åˆ‡
                    if (isCircle) {
                        const dist = Math.sqrt(Math.pow(x-50, 2) + Math.pow(y-50, 2));
                        if(dist > 50) continue; 
                    }
                }

                // ç»Ÿä¸€è¾¹ç•Œæ£€æŸ¥ (é˜²æ­¢å› ä¸ºæµ®ç‚¹è¯¯å·®ç¨å¾®å‡ºç•Œ)
                if (x < 0 || x > 100 || y < 0 || y > 100) continue;

                generatedCount++;
                state.plants.push({
                    x, y,
                    speciesId: sp.id, 
                    size: sp.size, color: sp.color, shape: sp.shape, style: sp.style
                });

                const el = createPlantElement(sp.size, sp.color, sp.shape, sp.style);
                el.style.left = x + '%';
                el.style.top = y + '%';
                fragment.appendChild(el);
            }
        });

        DOM.simArea.appendChild(fragment);
    }

    function createPlantElement(size, color, shape, style) {
        const div = document.createElement('div');
        div.className = 'plant-anchor';
        div.style.width = size + 'px';
        div.style.height = size + 'px';

        const ns = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(ns, "svg");
        svg.setAttribute("viewBox", "0 0 100 100");
        svg.setAttribute("class", "plant-svg");
        svg.style.width = "100%";
        svg.style.height = "100%";

        const fill = style === 'hollow' ? 'none' : color;
        const stroke = style === 'hollow' ? color : 'none';
        const strokeWidth = style === 'hollow' ? 15 : 0; 

        let el;
        const paths = {
            square: `M 10 10 H 90 V 90 H 10 Z`,
            triangle: `M 50 10 L 90 90 L 10 90 Z`,
            rhombus: `M 50 5 L 95 50 L 50 95 L 5 50 Z`,
            star: `M 50 5 L 61 38 L 95 38 L 68 59 L 79 95 L 50 75 L 21 95 L 32 59 L 5 38 L 39 38 Z`
        };

        if (shape === 'circle') {
            el = document.createElementNS(ns, "circle");
            el.setAttribute("cx", "50");
            el.setAttribute("cy", "50");
            el.setAttribute("r", "40");
        } else {
            el = document.createElementNS(ns, "path");
            el.setAttribute("d", paths[shape] || paths.square);
        }

        el.setAttribute("fill", fill);
        el.setAttribute("stroke", stroke);
        el.setAttribute("stroke-width", strokeWidth);
        el.setAttribute("stroke-linejoin", "round");

        svg.appendChild(el);
        div.appendChild(svg);
        return div;
    }

    // --- äº¤äº’é€»è¾‘ ---

    function selectPreset(size, el) {
        if (state.quadrats.length > 0 && state.mode === 'place') return;
        state.currentPreset = size;
        document.querySelectorAll('.preset-item').forEach(i => i.classList.remove('selected'));
        el.classList.add('selected');
        
        const display = document.getElementById('preset-info');
        const customDiv = document.getElementById('custom-input-div');
        if (size === 'custom') {
            customDiv.style.display = 'flex';
            const val = document.getElementById('custom-size-input').value;
            display.innerText = `å½“å‰é€‰æ‹©: è‡ªå®šä¹‰ ${val}m`;
        } else {
            customDiv.style.display = 'none';
            display.innerText = `å½“å‰é€‰æ‹©: è¾¹é•¿ ${size}m`;
        }
    }
    
    document.getElementById('custom-size-input').addEventListener('input', (e) => {
        state.customSize = parseInt(e.target.value) || 1;
        document.getElementById('preset-info').innerText = `å½“å‰é€‰æ‹©: è‡ªå®šä¹‰ ${state.customSize}m`;
    });

    function setMode(mode) {
        Object.values(DOM.btns).forEach(b => b.classList.remove('highlight'));
        if (state.mode === mode) {
            state.mode = null;
            document.getElementById('mode-info').innerText = "æ“ä½œå·²å–æ¶ˆ";
            return;
        }
        state.mode = mode;
        if(DOM.btns[mode]) DOM.btns[mode].classList.add('highlight');
        const map = {
            'place': 'ç‚¹å‡»åŒºåŸŸæ”¾ç½®æ ·æ–¹',
            'move': 'æ‹–æ‹½ç§»åŠ¨æ ·æ–¹',
            'delete': 'ç‚¹å‡»æ ·æ–¹åˆ é™¤'
        };
        document.getElementById('mode-info').innerText = map[mode];
    }

    function setupEventListeners() {
        DOM.simArea.addEventListener('mousedown', handleAreaInteraction);
        DOM.simArea.addEventListener('touchstart', handleAreaInteraction, {passive: false});
    }

    function handleAreaInteraction(e) {
        if (state.mode !== 'place') return;
        if(e.cancelable) e.preventDefault();
        const rect = DOM.simArea.getBoundingClientRect();
        const cx = e.clientX || e.touches[0].clientX;
        const cy = e.clientY || e.touches[0].clientY;
        const xPct = ((cx - rect.left) / rect.width) * 100;
        const yPct = ((cy - rect.top) / rect.height) * 100;
        addQuadrat(xPct, yPct, cx, cy);
    }

    // æ£€æŸ¥ç‚¹æ˜¯å¦åœ¨æœ‰æ•ˆåœ°å½¢åŒºåŸŸå†…
    function checkLocationValid(xPct, yPct) {
        const shape = state.settings.shape;
        // ç›¸å¯¹äºä¸­å¿ƒ (50,50) çš„åæ ‡
        const dx = xPct - 50;
        const dy = yPct - 50;
        const dist = Math.sqrt(dx*dx + dy*dy);

        if (shape === 'circle') {
            return dist <= 50;
        } 
        if (shape === 'ring') {
            const rOut = 50;
            const rIn = (state.settings.ringInner / state.settings.areaSize) * 50;
            
            if (dist > rOut || dist < rIn) return false;

            // è§’åº¦æ£€æŸ¥
            let angleDeg = Math.atan2(dy, dx) * 180 / Math.PI; // -180 ~ 180
            angleDeg += 90; // ä¿®æ­£ä¸º 0=Up, é¡ºæ—¶é’ˆ
            if (angleDeg < 0) angleDeg += 360; // 0 ~ 360

            const start = state.settings.ringStart;
            const end = state.settings.ringEnd;
            
            // å¤„ç†è·¨è¶Š 0 åº¦çš„æƒ…å†µ (å¦‚ 350 - 10)
            if (start <= end) {
                return angleDeg >= start && angleDeg <= end;
            } else {
                return angleDeg >= start || angleDeg <= end;
            }
        }
        return true; // square, rect
    }

    function addQuadrat(initialX, initialY, cx, cy) {
        let sizeM = state.currentPreset === 'custom' ? state.customSize : state.currentPreset;
        
        const widthM = state.settings.areaSize;
        let heightM = widthM;
        if(state.settings.shape === 'rect169') heightM = widthM * 9 / 16;
        
        const wPct = (sizeM / widthM) * 100;
        const hPct = (sizeM / heightM) * 100;
        
        // 1. åŸºç¡€è¾¹ç•Œé™åˆ¶ (ä¸è¶…å‡ºçŸ©å½¢å®¹å™¨)
        let x = Math.max(wPct/2, Math.min(100 - wPct/2, initialX));
        let y = Math.max(hPct/2, Math.min(100 - hPct/2, initialY));

        // 2. ç‰¹æ®Šå½¢çŠ¶é™åˆ¶ (ä»…æ£€æŸ¥æ ·æ–¹ä¸­å¿ƒç‚¹æ˜¯å¦åœ¨æœ‰æ•ˆåŒºåŸŸï¼Œå¢å¼ºç”¨æˆ·ä½“éªŒ)
        if (!checkLocationValid(x, y)) {
             showToast(cx, cy, "âš ï¸ æ ·æ–¹ä¸­å¿ƒéœ€ä½äºæœ‰æ•ˆåœ°å½¢å†…");
             return;
        }

        // 3. é‡å æ£€æŸ¥
        for (let q of state.quadrats) {
            const xDist = Math.abs(x - q.x);
            const yDist = Math.abs(y - q.y);
            const minX = (wPct + q.wPct)/2 - 0.1;
            const minY = (hPct + q.hPct)/2 - 0.1;

            if (xDist < minX && yDist < minY) {
                showToast(cx, cy, "âš ï¸ ä½ç½®é‡å ");
                return;
            }
        }

        const id = state.nextId++;
        const el = document.createElement('div');
        el.className = 'quadrat';
        el.style.width = wPct + '%';
        el.style.height = hPct + '%';
        el.style.left = x + '%';
        el.style.top = y + '%';
        el.innerText = state.quadrats.length + 1;
        el.addEventListener('mousedown', (ev) => handleQuadratClick(ev, id));
        el.addEventListener('touchstart', (ev) => handleQuadratClick(ev, id));

        DOM.simArea.appendChild(el);
        state.quadrats.push({ 
            id, x, y, 
            wPct, hPct, 
            wM: sizeM, hM: sizeM, 
            userCount: null, element: el 
        });
    }

    function handleQuadratClick(e, id) {
        e.stopPropagation();
        const qIndex = state.quadrats.findIndex(q => q.id === id);
        const q = state.quadrats[qIndex];

        if (state.mode === 'counting') {
            openCountModal(q);
        } else if (state.mode === 'delete') {
            q.element.remove();
            state.quadrats.splice(qIndex, 1);
            state.quadrats.forEach((item, idx) => item.element.innerText = idx + 1);
        } else if (state.mode === 'move') {
            startDrag(e, q);
        }
    }

    function startDrag(e, q) {
        const startX = e.clientX || e.touches[0].clientX;
        const startY = e.clientY || e.touches[0].clientY;
        const startL = parseFloat(q.element.style.left);
        const startT = parseFloat(q.element.style.top);
        const rect = DOM.simArea.getBoundingClientRect();

        const onMove = (evt) => {
            const cx = evt.clientX || evt.touches[0].clientX;
            const cy = evt.clientY || evt.touches[0].clientY;
            const dx = ((cx - startX)/rect.width)*100;
            const dy = ((cy - startY)/rect.height)*100;
            let nx = Math.max(q.wPct/2, Math.min(100-q.wPct/2, startL + dx));
            let ny = Math.max(q.hPct/2, Math.min(100-q.hPct/2, startT + dy));
            
            // æ‹–æ‹½æ—¶å¦‚æœä¸­å¿ƒç§»å‡ºæœ‰æ•ˆåŒºï¼Œåˆ™ä¸å…è®¸ç§»åŠ¨åˆ°è¯¥ä½ç½® (å¸é™„æ•ˆæœ)
            if (state.settings.shape !== 'square' && state.settings.shape !== 'rect169') {
                if(!checkLocationValid(nx, ny)) return;
            }

            q.element.style.left = nx + '%';
            q.element.style.top = ny + '%';
            q.tempX = nx; q.tempY = ny;
        };
        const onUp = () => {
            if(q.tempX) { q.x = q.tempX; q.y = q.tempY; }
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('touchend', onUp);
        };
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
        document.addEventListener('touchmove', onMove, {passive:false});
        document.addEventListener('touchend', onUp);
    }

    // --- ç»Ÿè®¡é€»è¾‘ ---

    function startStatistics() {
        if (state.quadrats.length === 0) {
            alert("è¯·å…ˆæ”¾ç½®æ ·æ–¹");
            return;
        }
        
        state.targetSpeciesId = DOM.targetSelect.value;
        const targetSp = state.settings.species.find(s => s.id === state.targetSpeciesId);
        if(!targetSp) { alert("è¯·é€‰æ‹©æœ‰æ•ˆçš„ç»Ÿè®¡ç‰©ç§"); return; }

        state.mode = 'counting';
        Object.values(DOM.btns).forEach(b => { b.disabled = true; b.classList.remove('highlight'); });
        
        document.getElementById('stats-panel').style.display = 'block';
        document.getElementById('stats-target-name').innerText = targetSp.name;
        document.getElementById('stats-target-name').style.color = targetSp.color;
        document.getElementById('stats-target-name').style.fontWeight = "bold";
        document.getElementById('mode-info').innerText = "ç»Ÿè®¡æ¨¡å¼è¿›è¡Œä¸­...";
        
        document.getElementById('target-select-wrapper').style.pointerEvents = 'none'; 
        document.getElementById('target-select-wrapper').style.opacity = '0.7';
    }

    function openCountModal(q) {
        const targetSp = state.settings.species.find(s => s.id === state.targetSpeciesId);
        document.getElementById('modal-target-name').innerText = targetSp.name;
        document.getElementById('modal-target-name').style.color = targetSp.color;

        DOM.modal.style.display = 'flex';
        DOM.modal.querySelector('input').value = q.userCount !== null ? q.userCount : '';
        setTimeout(() => DOM.modal.querySelector('input').focus(), 100);
        
        const container = document.getElementById('modal-view');
        container.innerHTML = '';
        const containerRect = container.getBoundingClientRect();
        const VIEW_SIZE_PX = containerRect.width; 
        
        const viewScale = 1.2; 
        const viewMeters = q.wM * viewScale; 
        
        const boxSizePx = (q.wM / viewMeters) * VIEW_SIZE_PX;
        
        const box = document.createElement('div');
        box.style.cssText = `
            width:${boxSizePx}px; height:${boxSizePx}px; 
            border:3px dashed #ff4757; 
            position:absolute; top:50%; left:50%; 
            transform:translate(-50%,-50%);
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        `;
        container.appendChild(box);

        const widthM = state.settings.areaSize;
        let heightM = widthM;
        if(state.settings.shape === 'rect169') heightM = widthM * 9 / 16;
        
        const cxPct = q.x;
        const cyPct = q.y;

        state.plants.forEach(p => {
            const dxPct = p.x - cxPct; 
            const dyPct = p.y - cyPct;
            
            const dxM = (dxPct / 100) * widthM;
            const dyM = (dyPct / 100) * heightM;

            if (Math.abs(dxM) <= viewMeters/2 && Math.abs(dyM) <= viewMeters/2) {
                const px = (dxM / viewMeters) * VIEW_SIZE_PX + VIEW_SIZE_PX/2;
                const py = (dyM / viewMeters) * VIEW_SIZE_PX + VIEW_SIZE_PX/2;

                const el = createPlantElement(p.size, p.color, p.shape, p.style);
                el.style.position = 'absolute';
                el.style.left = px + 'px';
                el.style.top = py + 'px';
                
                if (p.speciesId === state.targetSpeciesId) {
                    el.classList.add('plant-highlight');
                } else {
                    el.classList.add('plant-dimmed');
                }
                container.appendChild(el);
            }
        });

        state.currentQuadrat = q;
    }

    function closeModal() { DOM.modal.style.display = 'none'; }

    function submitCount() {
        const val = parseInt(DOM.modal.querySelector('input').value);
        if (isNaN(val) || val < 0) return;
        
        state.currentQuadrat.userCount = val;
        state.currentQuadrat.element.classList.add('completed');
        
        calculateTrueCount(state.currentQuadrat);
        closeModal();
        checkAllCompleted();
    }

    function calculateTrueCount(q) {
        const halfW = q.wPct / 2;
        const halfH = q.hPct / 2;
        const l = q.x - halfW, r = q.x + halfW;
        const t = q.y - halfH, b = q.y + halfH;
        const eps = 0.0001;
        
        let count = 0;
        state.plants.forEach(p => {
            if (p.speciesId !== state.targetSpeciesId) return; 
            let inX = (p.x > l + eps && p.x < r - eps) || Math.abs(p.x - l) <= eps; 
            let inY = (p.y > t + eps && p.y < b - eps) || Math.abs(p.y - t) <= eps;
            if (inX && inY) count++;
        });
        q.trueCount = count;
    }

    function checkAllCompleted() {
        if (state.quadrats.every(q => q.userCount !== null)) {
            let uSum = 0, tSum = 0; 
            state.quadrats.forEach(q => {
                const area = q.wM * q.hM;
                uSum += q.userCount / area; 
                tSum += q.trueCount / area;
            });
            const uAvg = uSum / state.quadrats.length; 
            
            const targetTotal = state.plants.filter(p => p.speciesId === state.targetSpeciesId).length;
            
            let totalArea = 0;
            const w = state.settings.areaSize;
            if(state.settings.shape === 'square') {
                totalArea = w * w;
            } else if (state.settings.shape === 'rect169') {
                totalArea = w * (w * 9/16);
            } else if (state.settings.shape === 'circle') {
                totalArea = Math.PI * Math.pow(w/2, 2);
            } else if (state.settings.shape === 'ring') {
                const rOut = w/2;
                const rIn = state.settings.ringInner;
                const angleSpan = Math.abs(state.settings.ringEnd - state.settings.ringStart);
                // é¢ç§¯ = (è§’åº¦/360) * pi * (R^2 - r^2)
                const ratio = angleSpan >= 359.9 ? 1 : (angleSpan / 360);
                totalArea = ratio * Math.PI * (Math.pow(rOut, 2) - Math.pow(rIn, 2));
            }

            const trueDensity = totalArea > 0 ? targetTotal / totalArea : 0;
            const err = trueDensity === 0 ? (uAvg===0?0:100) : Math.abs(uAvg - trueDensity)/trueDensity*100;
            const spName = state.settings.species.find(s=>s.id === state.targetSpeciesId).name;

            document.getElementById('result-display').style.display = 'block';
            document.getElementById('res-name').innerText = spName;
            document.getElementById('user-density').innerText = uAvg.toFixed(4);
            document.getElementById('true-density').innerText = trueDensity.toFixed(4);
            document.getElementById('error-rate').innerText = err.toFixed(2);
        }
    }

    function resetUIState() {
        // æ¸…é™¤æ¤ç‰©å…ƒç´ ï¼Œä½†ä¿ç•™åœ°å½¢SVGå±‚
        const plants = DOM.simArea.querySelectorAll('.plant-anchor');
        plants.forEach(p => p.remove());

        document.getElementById('stats-panel').style.display = 'none';
        document.getElementById('result-display').style.display = 'none';
        document.getElementById('target-select-wrapper').style.pointerEvents = 'auto';
        document.getElemen