<!DOCTYPE html>
<html lang="zh-CN">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../modules/auth/js/auth-guard.js"></script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="../Icon.svg" type="image/svg+xml">
    <title>å¤šåœ°å½¢æ ·æ–¹æ³•æ¨¡æ‹Ÿ</title>
    <link rel="stylesheet" href="../modules/qr-popup/css/qr-popup.css">
    <style>
        /* --- CSS å˜é‡å®šä¹‰ (æ”¯æŒæ·±è‰²æ¨¡å¼) --- */
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --highlight-color: #e74c3c;
            --bg-color: #f5f6fa;
            --panel-bg: #ffffff;
            --border-color: #dcdde1;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --input-bg: #ffffff;
            --modal-overlay: rgba(0, 0, 0, 0.5);
            --card-bg: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        /* æ–°å¢ä»£ç ï¼šè¿”å›ä¸»é¡µæŒ‰é’®çš„æ ·å¼ */
        .back-to-home {
            position: fixed;
            top: 5px;
            left: 5px;
            z-index: 9999;
            background-color: rgba(255, 255, 255, 0.8);
            color: #333;
            padding: 8px 12px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        .back-to-home:hover {
            background-color: white;
            transform: scale(1.05);
        }
        @media (prefers-color-scheme: dark) {
            .back-to-home {
                background-color: rgba(40, 40, 40, 0.8);
                color: #eee;
            }
            .back-to-home:hover {
                background-color: #333;
            }
        }
        /* æ·±è‰²æ¨¡å¼é€‚é… */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #ecf0f1;
                --accent-color: #5dade2;
                --highlight-color: #e74c3c;
                --bg-color: #1a1a1a;
                --panel-bg: #2d2d2d;
                --border-color: #444;
                --text-main: #ecf0f1;
                --text-sub: #bdc3c7;
                --input-bg: #3d3d3d;
                --modal-overlay: rgba(0, 0, 0, 0.8);
                --card-bg: #383838;
                --shadow: rgba(0, 0, 0, 0.5);
            }
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
            height: 100vh;
            display: flex;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* å¸ƒå±€: å·¦æ§å³æ¨¡ */
        @media (min-width: 768px) {
            body {
                flex-direction: row;
            }

            #control-panel {
                width: 400px;
                border-right: 1px solid var(--border-color);
                order: 1;
            }

            #simulation-container {
                flex: 1;
                order: 2;
            }
        }

        /* æ‰‹æœº: ä¸Šæ¨¡ä¸‹æ§ */
        @media (max-width: 767px) {
            body {
                flex-direction: column;
            }

            #simulation-container {
                flex: 1;
                order: 1;
            }

            #control-panel {
                height: 50%;
                order: 2;
                border-top: 1px solid var(--border-color);
                overflow-y: auto;
            }
        }

        #simulation-container {
            position: relative;
            background-color: var(--bg-color);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* æ¨¡æ‹ŸåŒºåŸŸ */
        #simulation-area {
            width: 100%;
            max-width: 80vh;
            /* èƒŒæ™¯å°†ç”±JSæ ¹æ®å½¢çŠ¶åŠ¨æ€ç”Ÿæˆ */
            background-color: transparent;
            border: 0px solid var(--text-main);
            /* è¾¹æ¡†ç”±èƒŒæ™¯å½¢çŠ¶å†³å®šï¼Œä¸ä½¿ç”¨CSS Border */
            position: relative;
            /* box-shadow: 0 0 15px var(--shadow); è‡ªå®šä¹‰å½¢çŠ¶ä¸‹é˜´å½±è¾ƒéš¾å¤„ç†ï¼Œæš‚æ—¶ç§»é™¤æˆ–ä»…åœ¨æ–¹å½¢å¯ç”¨ */
            transition: all 0.3s ease-in-out;
        }

        /* ä¸ºäº†æ˜¾ç¤ºè¾¹ç•Œï¼Œç»™æ–¹å½¢å¢åŠ ä¼ªå…ƒç´ è¾¹æ¡†ï¼Œåœ†å½¢/æ‰‡å½¢é€šè¿‡èƒŒæ™¯è‰²åŒºåˆ† */
        #simulation-area.bordered {
            border: 2px solid var(--text-main);
            background-color: var(--panel-bg);
            box-shadow: 0 0 15px var(--shadow);
        }

        .plant-anchor {
            position: absolute;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .plant-svg {
            overflow: visible;
        }

        /* å‘¼å¸åŠ¨ç”»ï¼šç”¨äºé«˜äº®ç›®æ ‡æ¤ç‰© */
        @keyframes target-pulse {
            0% {
                transform: scale(1);
                filter: drop-shadow(0 0 2px var(--accent-color));
            }

            50% {
                transform: scale(1.3);
                filter: drop-shadow(0 0 5px var(--accent-color));
            }

            100% {
                transform: scale(1);
                filter: drop-shadow(0 0 2px var(--accent-color));
            }
        }

        .plant-highlight {
            animation: target-pulse 1.5s infinite ease-in-out;
            z-index: 100;
        }

        .plant-dimmed {
            opacity: 0.2;
            filter: grayscale(80%);
        }

        .quadrat {
            position: absolute;
            border: 2px dashed #ff4757;
            background-color: rgba(255, 71, 87, 0.1);
            z-index: 10;
            cursor: grab;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            color: #ff4757;
            font-weight: bold;
            transform: translate(-50%, -50%);
        }

        .quadrat.completed {
            border-color: #2ecc71;
            background-color: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .toast-bubble {
            position: fixed;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -100%);
            margin-top: -10px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast-bubble.show {
            opacity: 1;
        }

        #control-panel {
            background-color: var(--panel-bg);
            display: flex;
            flex-direction: column;
            color: var(--text-main);
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-color);
            flex-shrink: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: var(--bg-color);
            border: none;
            font-weight: bold;
            color: var(--text-sub);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--panel-bg);
            color: var(--accent-color);
            border-bottom: 2px solid var(--accent-color);
        }

        .tab-content {
            display: none;
            padding: 15px;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .section-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--accent-color);
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preset-scroll {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            overflow-x: auto;
        }

        .preset-item {
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            background: var(--input-bg);
            color: var(--text-main);
            font-size: 13px;
            white-space: nowrap;
        }

        .preset-item.selected {
            border-color: var(--accent-color);
            background-color: var(--bg-color);
            color: var(--accent-color);
            font-weight: bold;
        }

        .btn {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-main);
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            transition: all 0.2s;
        }

        .action-group {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .btn.highlight {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .btn-danger.highlight {
            background-color: var(--highlight-color);
            border-color: var(--highlight-color);
            color: white;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--bg-color);
            border: none;
            font-size: 14px;
            margin-top: 5px;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
            border: none;
            margin-top: 15px;
        }

        .btn-sm {
            width: auto;
            padding: 4px 8px;
            font-size: 12px;
        }

        @media (prefers-color-scheme: dark) {
            .btn-primary {
                background-color: var(--accent-color);
                color: white;
            }
        }

        .info-display {
            background: var(--bg-color);
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            color: var(--text-sub);
            line-height: 1.4;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
        }

        .result-box {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 10px;
            margin-top: 10px;
            font-size: 13px;
            border-radius: 4px;
        }

        .result-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 1px dashed var(--border-color);
        }

        .setting-item {
            margin-bottom: 10px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: var(--text-main);
        }

        input[type="text"],
        input[type="number"],
        select {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 13px;
            width: 100%;
            background: var(--input-bg);
            color: var(--text-main);
        }

        input[type="range"] {
            width: 100%;
            accent-color: var(--accent-color);
        }

        .species-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-left: 4px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            position: relative;
        }

        .species-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .species-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--modal-overlay);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(3px);
        }

        .modal {
            background: var(--panel-bg);
            padding: 25px;
            border-radius: 12px;
            width: 650px;
            max-width: 95vw;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            color: var(--text-main);
        }

        .quadrat-view-container {
            width: 500px;
            height: 500px;
            max-width: 100%;
            aspect-ratio: 1/1;
            margin: 0 auto;
            position: relative;
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            overflow: hidden;
            border-radius: 8px;
        }

        @media (max-width: 600px) {
            .modal {
                width: 95vw;
                padding: 15px;
            }

            .quadrat-view-container {
                width: 100%;
                height: auto;
                aspect-ratio: 1/1;
            }
        }

        #target-select-wrapper {
            background: rgba(52, 152, 219, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            border: 1px solid var(--accent-color);
        }

        /* å½¢çŠ¶æ§åˆ¶ç»„èƒŒæ™¯ */
        .shape-control-group {
            background: rgba(0, 0, 0, 0.03);
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            margin-top: 5px;
            display: none;
        }
    </style>
</head>

<body>
    <a href="../index.html" class="back-to-home">ğŸ </a>
    <div id="toast-bubble" class="toast-bubble">æç¤ºä¿¡æ¯</div>

    <div id="control-panel">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('main')">ä¸»è¦åŠŸèƒ½</button>
            <button class="tab-btn" onclick="switchTab('settings')">å®éªŒè®¾ç½®</button>
        </div>

        <div id="tab-main" class="tab-content active">
            <div class="section">
                <div class="section-title">1. æ ·æ–¹é¢„è®¾</div>
                <div class="preset-scroll">
                    <div class="preset-item selected" onclick="selectPreset(1, this)">1m</div>
                    <div class="preset-item" onclick="selectPreset(2, this)">2m</div>
                    <div class="preset-item" onclick="selectPreset(5, this)">5m</div>
                    <div class="preset-item" onclick="selectPreset('custom', this)">è‡ªå®šä¹‰</div>
                </div>
                <div id="preset-info" class="info-display">å½“å‰é€‰æ‹©: è¾¹é•¿ 1m</div>
                <div id="custom-input-div"
                    style="display:none; align-items:center; gap:10px; margin-bottom:5px; font-size:13px;">
                    <label>è¾¹é•¿(m):</label>
                    <input type="number" id="custom-size-input" value="10" min="1" max="1000" style="width:80px;">
                </div>
            </div>

            <div class="section">
                <div class="section-title">2. æ“ä½œæ¨¡å¼</div>
                <div class="action-group">
                    <button class="btn" id="btn-place" onclick="setMode('place')">æ”¾ç½®</button>
                    <button class="btn" id="btn-move" onclick="setMode('move')">ç§»åŠ¨</button>
                    <button class="btn btn-danger" id="btn-delete" onclick="setMode('delete')">åˆ é™¤</button>
                </div>
                <div class="info-display" id="mode-info">è¯·é€‰æ‹©æ“ä½œæ¨¡å¼</div>
            </div>

            <div class="section">
                <div class="section-title">3. ç»Ÿè®¡åˆ†æ</div>

                <div id="target-select-wrapper">
                    <label style="font-weight:bold; font-size:13px; color:var(--text-main);">ğŸ¯ é€‰æ‹©ç›®æ ‡ç»Ÿè®¡ç‰©ç§:</label>
                    <select id="main-target-species" style="margin-top:5px; font-weight:bold;">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </select>
                    <div style="font-size:11px; color:var(--text-sub); margin-top:4px;">* ç»Ÿè®¡æ—¶éç›®æ ‡æ¤ç‰©ä¼šè‡ªåŠ¨å˜æš—</div>
                </div>

                <button class="btn btn-primary" id="btn-start-stats" onclick="startStatistics()">å¼€å§‹ç»Ÿè®¡æ¨¡å¼</button>

                <div id="stats-panel" style="display:none; margin-top: 15px;">
                    <div class="info-display">
                        ç»Ÿè®¡ä¸­... è¯·ç‚¹å‡»çº¢è‰²æ ·æ–¹å½•å…¥ [<span id="stats-target-name">--</span>] çš„æ•°é‡ã€‚<br>
                    </div>

                    <div id="result-display" style="display:none;">
                        <div class="result-box" style="border-left: 4px solid var(--accent-color);">
                            <div class="section-title">ç»Ÿè®¡ç»“æœæŠ¥å‘Š</div>
                            <div class="result-line"><span>ç›®æ ‡ç‰©ç§:</span> <strong id="res-name">--</strong></div>
                            <div class="result-line"><span>çœŸå®ç§ç¾¤å¯†åº¦:</span> <strong id="true-density">--</strong> æ ª/mÂ²
                            </div>
                            <div class="result-line"><span>æ‚¨çš„ä¼°ç®—å¯†åº¦:</span> <strong id="user-density">--</strong> æ ª/mÂ²
                            </div>
                            <div class="result-line"><span>ç›¸å¯¹è¯¯å·®:</span> <strong id="error-rate"
                                    style="color:var(--highlight-color)">--</strong>%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="section">
                <div class="section-title">ç¯å¢ƒå‚æ•°</div>
                <div class="setting-item">
                    <label>åœ°å½¢å½¢çŠ¶:</label>
                    <select id="setting-shape" onchange="toggleShapeControls(); updateSettings()">
                        <option value="square">æ­£æ–¹å½¢ (1:1)</option>
                        <option value="rect169">é•¿æ–¹å½¢ (16:9)</option>
                        <option value="circle">åœ†å½¢ / æ‰‡å½¢</option>
                        <option value="ring">ç¯å½¢ / ç¯æ‰‡</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>ä¸»è¾¹é•¿ / å¤–å¾„ (m):</label>
                    <input type="number" id="setting-area-size" value="15" min="1" max="1000"
                        onchange="updateSettings()">
                </div>

                <!-- ç¯å½¢/åœ†å½¢ é«˜çº§å‚æ•° -->
                <div id="setting-shape-advanced" class="shape-control-group">
                    <div class="setting-item" id="setting-inner-wrapper">
                        <label style="color: var(--accent-color); font-weight:bold;">å†…å¾„ (m):</label>
                        <input type="number" id="setting-inner-size" value="5" min="0" max="1000"
                            onchange="updateSettings()">
                        <div style="font-size:11px; color:var(--text-sub); margin-top:3px;">* å†…å¾„å¿…é¡»å°äºå¤–å¾„</div>
                    </div>

                    <div class="setting-item" style="margin-top:10px;">
                        <label style="display:flex; justify-content:space-between;">
                            <span>èµ·å§‹è§’åº¦ (0 = 9ç‚¹é’Ÿ):</span>
                            <span id="label-angle-start" style="font-weight:bold; color:var(--accent-color)">0Â°</span>
                        </label>
                        <input type="range" id="setting-angle-start" min="0" max="360" value="0" step="5"
                            oninput="updateAngleLabels(); updateSettings()">
                    </div>

                    <div class="setting-item">
                        <label style="display:flex; justify-content:space-between;">
                            <span>ç»ˆæ­¢è§’åº¦ (é¡ºæ—¶é’ˆ):</span>
                            <span id="label-angle-end" style="font-weight:bold; color:var(--accent-color)">360Â°</span>
                        </label>
                        <input type="range" id="setting-angle-end" min="0" max="360" value="360" step="5"
                            oninput="updateAngleLabels(); updateSettings()">
                        <div style="font-size:11px; color:var(--text-sub); margin-top:3px;">* è‹¥èµ·å§‹>ç»ˆæ­¢ï¼ŒåŒºåŸŸå°†è·¨è¶ŠåŸç‚¹</div>
                    </div>
                </div>

                <div class="setting-item">
                    <label>éšæœºç§å­ (Seed):</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="setting-seed" placeholder="ä»»æ„å­—ç¬¦" value="BioLab" style="flex:1;"
                            onchange="updateSettings()">
                        <button class="btn btn-sm" onclick="randomizeSeed()">ğŸ²</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">
                    <span>ç‰©ç§åˆ—è¡¨ (Species)</span>
                    <button class="btn btn-sm btn-primary" style="width:auto;" onclick="addNewSpecies()">+ æ·»åŠ </button>
                </div>
                <div id="species-list-container"></div>
            </div>

            <button class="btn btn-primary" onclick="resetSimulation()">åº”ç”¨è®¾ç½®å¹¶é‡ç½®</button>
            <button class="btn btn-success" onclick="shareConfiguration()">ğŸ”— ç”Ÿæˆåˆ†äº«é“¾æ¥</button>
        </div>
    </div>

    <div id="simulation-container">
        <!-- æ¨¡æ‹ŸåŒºåŸŸ -->
        <div id="simulation-area"></div>

        <!-- æ¯”ä¾‹å°ºä¿¡æ¯ -->
        <div
            style="position: absolute; bottom: 5px; right: 10px; font-size: 12px; color: #555; background:rgba(255,255,255,0.8); padding:4px 8px; border-radius:3px; box-shadow:0 1px 3px rgba(0,0,0,0.1); pointer-events: none;">
            å°ºå¯¸: <span id="area-scale-label">15</span>m x <span id="area-scale-label-2">15</span>m <span
                id="area-shape-label"></span>
        </div>
    </div>

    <!-- è®¡æ•°å½•å…¥æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="count-modal">
        <div class="modal">
            <div class="modal-header"
                style="text-align: center; padding-bottom:10px; border-bottom:1px solid var(--border-color);">
                <span style="font-size:18px; font-weight:bold;">æ ·æ–¹è®¡æ•° (ä¿¯è§†å›¾)</span>
                <div style="font-size: 13px; color: var(--text-sub); margin-top:5px;">
                    è¯·ç»Ÿè®¡: <span id="modal-target-name"
                        style="color:var(--highlight-color); font-weight:bold; font-size:15px;">--</span>
                    <span style="font-size:11px; margin-left:5px;">(å…¶ä»–æ¤ç‰©å·²è‡ªåŠ¨å˜æš—)</span>
                </div>
            </div>

            <div class="quadrat-view-container" id="modal-view"></div>

            <div>
                <label style="font-size:14px; font-weight:bold;">å½•å…¥æ•°é‡:</label>
                <input type="number" id="modal-input-count"
                    style="width: 100%; margin-top: 5px; padding: 12px; font-size:18px; text-align:center;">
            </div>
            <div class="modal-actions" style="display:flex; gap:15px;">
                <button class="btn" style="flex:1; height:45px;" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn highlight" style="flex:2; height:45px; font-size:16px;"
                    onclick="submitCount()">ç¡®è®¤å½•å…¥</button>
            </div>
        </div>
    </div>
    <script src="../modules/qr-popup/js/qrcode.min.js"></script>
    <script src="../modules/qr-popup/js/qr-popup.js"></script>
    <script>
        // é»˜è®¤ç‰©ç§é…ç½®
        const DEFAULT_SPECIES = [
            { id: 's1', name: 'è’²å…¬è‹±', count: 120, size: 8, shape: 'circle', style: 'solid', color: '#f1c40f', dispersion: 1.0 },
            { id: 's2', name: 'è½¦å‰è‰', count: 80, size: 12, shape: 'triangle', style: 'hollow', color: '#2ecc71', dispersion: 0.3 }
        ];

        const state = {
            mode: null,
            settings: {
                areaSize: 15,  // å¤–å¾„æˆ–å®½
                innerSize: 5,  // å†…å¾„ï¼ˆä»…ç”¨äºç¯å½¢ï¼‰
                startAngle: 0,
                endAngle: 360,
                shape: 'square', // square, rect169, circle, ring
                seed: "BioLab",
                species: JSON.parse(JSON.stringify(DEFAULT_SPECIES))
            },
            targetSpeciesId: null, // ç»Ÿè®¡ç›®æ ‡
            currentPreset: 1,
            customSize: 10,
            plants: [],
            quadrats: [],
            nextId: 1
        };

        const DOM = {
            simArea: document.getElementById('simulation-area'),
            modal: document.getElementById('count-modal'),
            toast: document.getElementById('toast-bubble'),
            speciesContainer: document.getElementById('species-list-container'),
            targetSelect: document.getElementById('main-target-species'),
            shapeControls: document.getElementById('setting-shape-advanced'),
            innerSizeWrapper: document.getElementById('setting-inner-wrapper'),
            btns: {
                place: document.getElementById('btn-place'),
                move: document.getElementById('btn-move'),
                delete: document.getElementById('btn-delete')
            }
        };

        // --- éšæœºæ•°ç”Ÿæˆå™¨ ---
        let seedState = 0;
        function initSeed(str)
        {
            let h = 2166136261 >>> 0;
            for (let i = 0; i < str.length; i++)
            {
                h = Math.imul(h ^ str.charCodeAt(i), 16777619);
            }
            seedState = h;
        }
        function seededRandom()
        {
            seedState += 0x6D2B79F5;
            let t = seedState;
            t = Math.imul(t ^ t >>> 15, t | 1);
            t ^= t + Math.imul(t ^ t >>> 7, t | 61);
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }

        // --- åˆå§‹åŒ– ---
        function init()
        {
            loadSettingsFromURL();
            renderSpeciesSettings();
            toggleShapeControls();
            updateAngleLabels();
            resetSimulation();
            setupEventListeners();
        }

        // --- è®¾ç½®é€»è¾‘ ---

        function renderSpeciesSettings()
        {
            DOM.speciesContainer.innerHTML = '';
            state.settings.species.forEach((sp, index) =>
            {
                const card = document.createElement('div');
                card.className = 'species-card';
                card.style.borderLeftColor = sp.color;

                card.innerHTML = `
                <div class="species-header">
                    <input type="text" value="${sp.name}" onchange="updateSpeciesParam('${sp.id}', 'name', this.value)" style="width:60%; font-weight:bold;">
                    <button class="btn btn-sm btn-danger highlight" style="width:auto;" onclick="removeSpecies('${sp.id}')">åˆ é™¤</button>
                </div>
                <div class="species-grid">
                    <div>
                        <label>æ•°é‡:</label>
                        <input type="number" value="${sp.count}" min="1" max="2000" onchange="updateSpeciesParam('${sp.id}', 'count', parseInt(this.value))">
                    </div>
                    <div>
                        <label>å¤§å°(px):</label>
                        <input type="number" value="${sp.size}" min="2" max="50" onchange="updateSpeciesParam('${sp.id}', 'size', parseInt(this.value))">
                    </div>
                    <div>
                        <label>å½¢çŠ¶:</label>
                        <select onchange="updateSpeciesParam('${sp.id}', 'shape', this.value)">
                            <option value="circle" ${sp.shape == 'circle' ? 'selected' : ''}>åœ†å½¢</option>
                            <option value="square" ${sp.shape == 'square' ? 'selected' : ''}>æ­£æ–¹å½¢</option>
                            <option value="triangle" ${sp.shape == 'triangle' ? 'selected' : ''}>ä¸‰è§’å½¢</option>
                            <option value="rhombus" ${sp.shape == 'rhombus' ? 'selected' : ''}>è±å½¢</option>
                            <option value="star" ${sp.shape == 'star' ? 'selected' : ''}>æ˜Ÿå½¢</option>
                        </select>
                    </div>
                    <div>
                        <label>é£æ ¼:</label>
                        <select onchange="updateSpeciesParam('${sp.id}', 'style', this.value)">
                            <option value="solid" ${sp.style == 'solid' ? 'selected' : ''}>å®å¿ƒ</option>
                            <option value="hollow" ${sp.style == 'hollow' ? 'selected' : ''}>ç©ºå¿ƒ</option>
                        </select>
                    </div>
                    <div style="grid-column: span 2; display:flex; gap:10px; align-items:center;">
                        <label style="margin:0;">é¢œè‰²:</label>
                        <input type="color" value="${sp.color}" onchange="updateSpeciesParam('${sp.id}', 'color', this.value)" style="flex:1; height:30px;">
                    </div>
                    <div style="grid-column: span 2;">
                        <label>åˆ†å¸ƒç¦»æ•£åº¦ (0èš-1æ•£): ${sp.dispersion}</label>
                        <input type="range" min="0" max="1" step="0.1" value="${sp.dispersion}" 
                            onchange="updateSpeciesParam('${sp.id}', 'dispersion', parseFloat(this.value))"
                            style="width:100%">
                    </div>
                </div>
            `;
                DOM.speciesContainer.appendChild(card);
            });
            updateMainTargetSelect();
        }

        function addNewSpecies()
        {
            const colors = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6'];
            const shapes = ['circle', 'square', 'triangle', 'star'];
            const id = 's' + Date.now();
            const randColor = colors[state.settings.species.length % colors.length];
            const randShape = shapes[state.settings.species.length % shapes.length];

            state.settings.species.push({
                id: id,
                name: `æ–°ç‰©ç§ ${state.settings.species.length + 1}`,
                count: 50,
                size: 8,
                shape: randShape,
                style: 'solid',
                color: randColor,
                dispersion: 0.8
            });
            renderSpeciesSettings();
        }

        function removeSpecies(id)
        {
            if (state.settings.species.length <= 1)
            {
                alert("è‡³å°‘ä¿ç•™ä¸€ç§æ¤ç‰©ï¼");
                return;
            }
            state.settings.species = state.settings.species.filter(s => s.id !== id);
            renderSpeciesSettings();
        }

        function updateSpeciesParam(id, key, val)
        {
            const sp = state.settings.species.find(s => s.id === id);
            if (sp) sp[key] = val;
        }

        function updateMainTargetSelect()
        {
            DOM.targetSelect.innerHTML = '';
            state.settings.species.forEach(sp =>
            {
                const opt = document.createElement('option');
                opt.value = sp.id;
                opt.innerText = sp.name;
                opt.style.color = sp.color;
                DOM.targetSelect.appendChild(opt);
            });
        }

        function toggleShapeControls()
        {
            const shape = document.getElementById('setting-shape').value;
            if (shape === 'circle' || shape === 'ring')
            {
                DOM.shapeControls.style.display = 'block';
                if (shape === 'ring')
                {
                    DOM.innerSizeWrapper.style.display = 'block';
                } else
                {
                    DOM.innerSizeWrapper.style.display = 'none';
                }
            } else
            {
                DOM.shapeControls.style.display = 'none';
            }
        }

        function updateAngleLabels()
        {
            const s = document.getElementById('setting-angle-start').value;
            const e = document.getElementById('setting-angle-end').value;
            document.getElementById('label-angle-start').innerText = s + 'Â°';
            document.getElementById('label-angle-end').innerText = e + 'Â°';
        }

        function updateSettings()
        {
            let size = parseInt(document.getElementById('setting-area-size').value);
            if (size < 1) size = 1; if (size > 1000) size = 1000;
            state.settings.areaSize = size;

            let inSize = parseFloat(document.getElementById('setting-inner-size').value);
            if (isNaN(inSize)) inSize = 0;
            state.settings.innerSize = inSize;

            state.settings.seed = document.getElementById('setting-seed').value;
            state.settings.shape = document.getElementById('setting-shape').value;
            state.settings.startAngle = parseInt(document.getElementById('setting-angle-start').value);
            state.settings.endAngle = parseInt(document.getElementById('setting-angle-end').value);

            // æ›´æ–°æ˜¾ç¤ºæ ‡ç­¾
            let h = size;
            if (state.settings.shape === 'rect169') h = (size * 9 / 16).toFixed(1);

            document.getElementById('area-scale-label').innerText = size;
            document.getElementById('area-scale-label-2').innerText = (state.settings.shape === 'circle' || state.settings.shape === 'ring') ? size : h;

            const shapeNames = {
                'square': '(æ­£æ–¹å½¢)',
                'rect169': '(16:9)',
                'circle': '(åœ†å½¢/æ‰‡å½¢)',
                'ring': `(ç¯å½¢/ç¯æ‰‡)`
            };
            document.getElementById('area-shape-label').innerText = shapeNames[state.settings.shape];
        }

        function randomizeSeed()
        {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let res = '';
            for (let i = 0; i < 6; i++) res += chars.charAt(Math.floor(Math.random() * chars.length));
            document.getElementById('setting-seed').value = res;
            updateSettings();
        }

        function shareConfiguration()
        {
            const config = {
                a: state.settings.areaSize,
                in: state.settings.innerSize,
                sa: state.settings.startAngle,
                ea: state.settings.endAngle,
                s: state.settings.seed,
                sh: state.settings.shape,
                sp: state.settings.species
            };
            const jsonStr = JSON.stringify(config);
            const encoded = encodeURIComponent(jsonStr);
            const url = `${window.location.origin}${window.location.pathname}?cfg=${encoded}`;

            window.QrPopupModule.show(url);
        }

        function loadSettingsFromURL()
        {
            const params = new URLSearchParams(window.location.search);
            if (params.has('cfg'))
            {
                try
                {
                    const config = JSON.parse(decodeURIComponent(params.get('cfg')));
                    if (config.a) state.settings.areaSize = config.a;
                    if (config.in !== undefined) state.settings.innerSize = config.in;
                    if (config.sa !== undefined) state.settings.startAngle = config.sa;
                    if (config.ea !== undefined) state.settings.endAngle = config.ea;
                    if (config.s) state.settings.seed = config.s;
                    if (config.sh) state.settings.shape = config.sh;
                    if (config.sp && Array.isArray(config.sp)) state.settings.species = config.sp;
                } catch (e)
                {
                    console.error("é…ç½®è§£æå¤±è´¥", e);
                }
            }
            document.getElementById('setting-area-size').value = state.settings.areaSize;
            document.getElementById('setting-inner-size').value = state.settings.innerSize;
            document.getElementById('setting-seed').value = state.settings.seed;
            document.getElementById('setting-shape').value = state.settings.shape || 'square';
            document.getElementById('setting-angle-start').value = state.settings.startAngle;
            document.getElementById('setting-angle-end').value = state.settings.endAngle;
        }

        // --- æ¨¡æ‹Ÿç”Ÿæˆé€»è¾‘ ---

        function resetSimulation()
        {
            updateSettings();
            initSeed(state.settings.seed);

            DOM.simArea.style.borderRadius = "0";
            DOM.simArea.style.background = "none";
            DOM.simArea.classList.remove('bordered');

            const { shape, areaSize, innerSize, startAngle, endAngle } = state.settings;

            if (shape === 'square')
            {
                DOM.simArea.style.aspectRatio = "1/1";
                DOM.simArea.classList.add('bordered');
            } else if (shape === 'rect169')
            {
                DOM.simArea.style.aspectRatio = "16/9";
                DOM.simArea.classList.add('bordered');
            } else if (shape === 'circle' || shape === 'ring')
            {
                DOM.simArea.style.aspectRatio = "1/1";
                DOM.simArea.style.borderRadius = "50%";

                // ç¯å½¢å†…å¾„å¤„ç†
                let holePct = 0;
                if (shape === 'ring')
                {
                    if (innerSize >= areaSize)
                    {
                        state.settings.innerSize = areaSize * 0.5;
                        document.getElementById('setting-inner-size').value = state.settings.innerSize;
                    }
                    holePct = (state.settings.innerSize / areaSize) * 100 / 2; // åŠå¾„ç™¾åˆ†æ¯”
                }

                // --- åŠ¨æ€æ„å»ºèƒŒæ™¯ (å®ç°æ‰‡å½¢/ç¯æ‰‡è§†è§‰) ---
                // ç›®æ ‡: 0åº¦ = 9ç‚¹é’Ÿæ–¹å‘ã€‚
                // CSS conic-gradient 0deg æ˜¯ 12ç‚¹é’Ÿã€‚
                // é¡ºæ—¶é’ˆ: 9ç‚¹(User 0) -> 12ç‚¹(User 90) -> 3ç‚¹(User 180) -> 6ç‚¹(User 270).
                // æ˜ å°„: CSS Angle = User Angle + 270 (æˆ–è€… -90).
                // åŸºç¡€æ—‹è½¬: `from 270deg` è®©CSSçš„0ç‚¹å¯¹å…¶Userçš„0ç‚¹(9ç‚¹é’Ÿ)ã€‚

                let bgImage = "";
                const bgCol = "var(--panel-bg)";
                const trans = "transparent";

                // ç¬¬ä¸€å±‚ï¼šä¸­é—´çš„æ´ (ä»…Ring) - æ”¾åœ¨æœ€ä¸Šé¢
                // ä½¿ç”¨ radial-gradient æ¨¡æ‹Ÿæ´ã€‚æ´æ˜¯é€æ˜çš„(æ˜¾ç¤ºbodyèƒŒæ™¯)ï¼Œä½†è¿™é‡Œä¸ºäº†é®æŒ¡conic-gradientï¼Œ
                // æˆ‘ä»¬éœ€è¦è®©æ´çš„éƒ¨åˆ†æ˜¯é€æ˜çš„å—ï¼Ÿ
                // å®é™…ä¸Š: 
                // 1. åº•å±‚: bodyé¢œè‰² (bg-color)
                // 2. æ¨¡æ‹ŸåŒº: conic-gradient ç»˜åˆ¶æ‰‡å½¢ (panel-bg)
                // 3. é¡¶å±‚: radial-gradient æŒ–æ´ (æŠŠä¸­é—´æ¶‚å› bodyé¢œè‰², æˆ–è€…mask)

                // æ–¹æ¡ˆ: ä½¿ç”¨å¤šé‡èƒŒæ™¯ã€‚
                // layer 1 (top): ç¯å½¢é®ç½© (ä¸­é—´æ˜¯bodyè‰²ï¼Œå¤–é¢é€æ˜) -> è¿™æ ·ä¼šç›–ä½æ‰‡å½¢
                // layer 2 (bottom): æ‰‡å½¢ (panel-bg)

                const holeGradient = shape === 'ring'
                    ? `radial-gradient(circle, var(--bg-color) ${holePct}%, transparent ${holePct}%)`
                    : null;

                // æ„å»º Conic Gradient å­—ç¬¦ä¸²
                let conicStr = "";
                const s = startAngle;
                const e = endAngle;

                // å½’ä¸€åŒ–å¤„ç†ï¼šç¡®ä¿ CSS æ¸²æŸ“æ­£ç¡®
                // å¦‚æœ s < e: æ­£å¸¸åŒºé—´ [s, e] ä¸ºé¢œè‰²ï¼Œå…¶ä½™é€æ˜
                // å¦‚æœ s > e: è·¨è¶Š0åº¦ï¼Œ[s, 360] U [0, e] ä¸ºé¢œè‰²ï¼Œä¸­é—´ [e, s] é€æ˜

                if (s === e || Math.abs(s - e) === 360)
                {
                    // å…¨åœ†
                    conicStr = `conic-gradient(var(--panel-bg) 0% 100%)`;
                } else if (s < e)
                {
                    conicStr = `conic-gradient(from 270deg, ${trans} 0deg, ${trans} ${s}deg, ${bgCol} ${s}deg, ${bgCol} ${e}deg, ${trans} ${e}deg)`;
                } else
                {
                    // è·¨è¶Š 0 ç‚¹ (ä¾‹å¦‚ start 270, end 90)
                    conicStr = `conic-gradient(from 270deg, ${bgCol} 0deg, ${bgCol} ${e}deg, ${trans} ${e}deg, ${trans} ${s}deg, ${bgCol} ${s}deg)`;
                }

                DOM.simArea.style.backgroundImage = holeGradient ? `${holeGradient}, ${conicStr}` : conicStr;
            }

            state.quadrats.forEach(q => q.element.remove());
            state.quadrats = [];
            state.mode = null;
            resetUIState();
            generatePlants();
            switchTab('main');
            updateMainTargetSelect();
        }

        // å°†ç¬›å¡å°”åæ ‡è½¬æ¢ä¸ºç”¨æˆ·å®šä¹‰çš„è§’åº¦ (0=9ç‚¹é’Ÿ, é¡ºæ—¶é’ˆ)
        // dx, dy æ˜¯ç›¸å¯¹äºä¸­å¿ƒç‚¹çš„åç§»
        function getAngle(dx, dy)
        {
            // Math.atan2(y, x): 0=3ç‚¹, 90=6ç‚¹, 180/-180=9ç‚¹, -90=12ç‚¹
            // ç”¨æˆ·å®šä¹‰: 0=9ç‚¹, é¡ºæ—¶é’ˆå¢åŠ ã€‚
            // æ˜ å°„:
            // (1, 0) East: User 180
            // (0, 1) South: User 270
            // (-1, 0) West: User 0
            // (0, -1) North: User 90

            let rad = Math.atan2(dy, dx);
            let deg = rad * 180 / Math.PI; // -180 to 180, 0 is East

            // å˜æ¢åˆ°ç”¨æˆ·åæ ‡ç³»
            // deg: 0(E), 90(S), 180(W), -90(N)
            // target: 180(E), 270(S), 0(W), 90(N)

            let userDeg = deg + 180; // 0(W) -> 0, 90(N) -> 90, 180(E) -> 180, 270(S) -> 270
            // atan2(-1, 0) -> PI/180deg -> +180 = 360/0.
            // atan2(0, -1) -> -PI/2/-90deg -> +180 = 90.
            // atan2(1, 0) -> 0deg -> +180 = 180.
            // atan2(0, 1) -> 90deg -> +180 = 270.

            // å¾®è°ƒï¼šç¡®ä¿åœ¨ [0, 360) åŒºé—´
            if (userDeg >= 360) userDeg -= 360;
            if (userDeg < 0) userDeg += 360;

            return userDeg;
        }

        function isPointInSector(xPct, yPct)
        {
            const { shape, areaSize, innerSize, startAngle, endAngle } = state.settings;
            if (shape === 'square' || shape === 'rect169') return true;

            const dx = xPct - 50;
            const dy = yPct - 50;
            const dist = Math.sqrt(dx * dx + dy * dy); // åŠå¾„ç™¾åˆ†æ¯” (0-50)

            // 1. è·ç¦»æ£€æŸ¥
            if (dist > 50) return false; // è¶…å‡ºå¤–å¾„

            if (shape === 'ring')
            {
                const innerRadPct = (innerSize / areaSize) * 50;
                if (dist < innerRadPct) return false; // åœ¨å†…å¾„é‡Œ
            }

            // 2. è§’åº¦æ£€æŸ¥
            if (startAngle === 0 && endAngle === 360) return true; // å…¨åœ†

            const angle = getAngle(dx, dy);

            if (startAngle <= endAngle)
            {
                return angle >= startAngle && angle <= endAngle;
            } else
            {
                // è·¨è¶Š0åº¦ (ä¾‹å¦‚ Start 270, End 90)
                return angle >= startAngle || angle <= endAngle;
            }
        }

        function generatePlants()
        {
            DOM.simArea.innerHTML = '';
            state.plants = [];
            const fragment = document.createDocumentFragment();
            const rand = seededRandom;

            state.settings.species.forEach(sp =>
            {
                const clusters = Math.max(1, Math.floor(sp.count / 20));
                const clusterCenters = [];
                // å°è¯•ç”Ÿæˆåˆæ³•çš„èšç±»ä¸­å¿ƒ
                for (let k = 0; k < clusters; k++)
                {
                    let cx, cy, valid = false;
                    let tries = 0;
                    while (!valid && tries < 50)
                    {
                        cx = rand() * 100;
                        cy = rand() * 100;
                        if (isPointInSector(cx, cy))
                        {
                            // ç¨å¾®æ”¶ç¼©èšç±»ä¸­å¿ƒï¼Œé¿å…å¤ªé è¾¹
                            valid = true;
                        }
                        tries++;
                    }
                    if (valid) clusterCenters.push({ x: cx, y: cy });
                }

                let generatedCount = 0;
                let attempts = 0;

                while (generatedCount < sp.count && attempts < sp.count * 20)
                {
                    attempts++;
                    let x, y;

                    if (clusterCenters.length > 0 && rand() >= sp.dispersion)
                    {
                        const center = clusterCenters[Math.floor(rand() * clusterCenters.length)];
                        const offset = () => (rand() - 0.5) * 15;
                        x = center.x + offset();
                        y = center.y + offset();
                    } else
                    {
                        x = rand() * 100;
                        y = rand() * 100;
                    }

                    // è¾¹ç•Œæ£€æŸ¥
                    if (x < 0 || x > 100 || y < 0 || y > 100) continue;

                    if (!isPointInSector(x, y)) continue;

                    generatedCount++;
                    state.plants.push({
                        x, y,
                        speciesId: sp.id,
                        size: sp.size, color: sp.color, shape: sp.shape, style: sp.style
                    });

                    const el = createPlantElement(sp.size, sp.color, sp.shape, sp.style);
                    el.style.left = x + '%';
                    el.style.top = y + '%';
                    fragment.appendChild(el);
                }
            });

            DOM.simArea.appendChild(fragment);
        }

        function createPlantElement(size, color, shape, style)
        {
            const div = document.createElement('div');
            div.className = 'plant-anchor';
            div.style.width = size + 'px';
            div.style.height = size + 'px';

            const ns = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(ns, "svg");
            svg.setAttribute("viewBox", "0 0 100 100");
            svg.setAttribute("class", "plant-svg");
            svg.style.width = "100%";
            svg.style.height = "100%";

            const fill = style === 'hollow' ? 'none' : color;
            const stroke = style === 'hollow' ? color : 'none';
            const strokeWidth = style === 'hollow' ? 15 : 0;

            let el;
            const paths = {
                square: `M 10 10 H 90 V 90 H 10 Z`,
                triangle: `M 50 10 L 90 90 L 10 90 Z`,
                rhombus: `M 50 5 L 95 50 L 50 95 L 5 50 Z`,
                star: `M 50 5 L 61 38 L 95 38 L 68 59 L 79 95 L 50 75 L 21 95 L 32 59 L 5 38 L 39 38 Z`
            };

            if (shape === 'circle')
            {
                el = document.createElementNS(ns, "circle");
                el.setAttribute("cx", "50");
                el.setAttribute("cy", "50");
                el.setAttribute("r", "40");
            } else
            {
                el = document.createElementNS(ns, "path");
                el.setAttribute("d", paths[shape] || paths.square);
            }

            el.setAttribute("fill", fill);
            el.setAttribute("stroke", stroke);
            el.setAttribute("stroke-width", strokeWidth);
            el.setAttribute("stroke-linejoin", "round");

            svg.appendChild(el);
            div.appendChild(svg);
            return div;
        }

        // --- äº¤äº’é€»è¾‘ ---

        function selectPreset(size, el)
        {
            if (state.quadrats.length > 0 && state.mode === 'place') return;
            state.currentPreset = size;
            document.querySelectorAll('.preset-item').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');

            const display = document.getElementById('preset-info');
            const customDiv = document.getElementById('custom-input-div');
            if (size === 'custom')
            {
                customDiv.style.display = 'flex';
                const val = document.getElementById('custom-size-input').value;
                display.innerText = `å½“å‰é€‰æ‹©: è‡ªå®šä¹‰ ${val}m`;
            } else
            {
                customDiv.style.display = 'none';
                display.innerText = `å½“å‰é€‰æ‹©: è¾¹é•¿ ${size}m`;
            }
        }

        document.getElementById('custom-size-input').addEventListener('input', (e) =>
        {
            state.customSize = parseInt(e.target.value) || 1;
            document.getElementById('preset-info').innerText = `å½“å‰é€‰æ‹©: è‡ªå®šä¹‰ ${state.customSize}m`;
        });

        function setMode(mode)
        {
            Object.values(DOM.btns).forEach(b => b.classList.remove('highlight'));
            if (state.mode === mode)
            {
                state.mode = null;
                document.getElementById('mode-info').innerText = "æ“ä½œå·²å–æ¶ˆ";
                return;
            }
            state.mode = mode;
            if (DOM.btns[mode]) DOM.btns[mode].classList.add('highlight');
            const map = {
                'place': 'ç‚¹å‡»åŒºåŸŸæ”¾ç½®æ ·æ–¹',
                'move': 'æ‹–æ‹½ç§»åŠ¨æ ·æ–¹',
                'delete': 'ç‚¹å‡»æ ·æ–¹åˆ é™¤'
            };
            document.getElementById('mode-info').innerText = map[mode];
        }

        function setupEventListeners()
        {
            DOM.simArea.addEventListener('mousedown', handleAreaInteraction);
            DOM.simArea.addEventListener('touchstart', handleAreaInteraction, { passive: false });
        }

        function handleAreaInteraction(e)
        {
            if (state.mode !== 'place') return;
            if (e.cancelable) e.preventDefault();
            const rect = DOM.simArea.getBoundingClientRect();
            const cx = e.clientX || e.touches[0].clientX;
            const cy = e.clientY || e.touches[0].clientY;
            const xPct = ((cx - rect.left) / rect.width) * 100;
            const yPct = ((cy - rect.top) / rect.height) * 100;
            addQuadrat(xPct, yPct, cx, cy);
        }

        // æ£€æŸ¥æ ·æ–¹æ˜¯å¦åˆæ³•ï¼ˆæ‰€æœ‰å››ä¸ªè§’éƒ½åœ¨æ‰‡å½¢/ç¯å½¢å†…éƒ¨ï¼‰
        function isQuadratValid(cx, cy, halfW, halfH)
        {
            // æ£€æŸ¥å››ä¸ªè§’
            const corners = [
                { x: cx - halfW, y: cy - halfH },
                { x: cx + halfW, y: cy - halfH },
                { x: cx + halfW, y: cy + halfH },
                { x: cx - halfW, y: cy + halfH }
            ];

            for (let p of corners)
            {
                // ç®€å•å¤„ç†ï¼šåªè¦æœ‰ä¸€ä¸ªè§’å‡ºç•Œï¼Œå°±è®¤ä¸ºä¸åˆæ³•
                // æ›´ä¸¥æ ¼çš„ç‰©ç†æ¨¡æ‹Ÿå¯èƒ½éœ€è¦ç›¸äº¤æ£€æµ‹ï¼Œä½†å¯¹æ•™å­¦æ¨¡æ‹Ÿé€šè¿‡å››ä¸ªè§’æ£€æµ‹è¶³å¤Ÿ
                if (!isPointInSector(p.x, p.y)) return false;
            }
            return true;
        }

        function addQuadrat(initialX, initialY, cx, cy)
        {
            let sizeM = state.currentPreset === 'custom' ? state.customSize : state.currentPreset;

            const widthM = state.settings.areaSize;
            let heightM = widthM;
            if (state.settings.shape === 'rect169') heightM = widthM * 9 / 16;

            const wPct = (sizeM / widthM) * 100;
            const hPct = (sizeM / heightM) * 100;

            let x = Math.max(wPct / 2, Math.min(100 - wPct / 2, initialX));
            let y = Math.max(hPct / 2, Math.min(100 - hPct / 2, initialY));

            // ç‰¹æ®Šåœ°å½¢è¾¹ç•Œæ£€æŸ¥
            if (state.settings.shape === 'circle' || state.settings.shape === 'ring')
            {
                if (!isQuadratValid(x, y, wPct / 2, hPct / 2))
                {
                    showToast(cx, cy, "âš ï¸ æ ·æ–¹éœ€å®Œå…¨ä½äºæœ‰æ•ˆåŒºåŸŸå†…");
                    return;
                }
            }

            // é‡å æ£€æŸ¥
            for (let q of state.quadrats)
            {
                const xDist = Math.abs(x - q.x);
                const yDist = Math.abs(y - q.y);
                const minX = (wPct + q.wPct) / 2 - 0.1;
                const minY = (hPct + q.hPct) / 2 - 0.1;

                if (xDist < minX && yDist < minY)
                {
                    showToast(cx, cy, "âš ï¸ ä½ç½®é‡å ");
                    return;
                }
            }

            const id = state.nextId++;
            const el = document.createElement('div');
            el.className = 'quadrat';
            el.style.width = wPct + '%';
            el.style.height = hPct + '%';
            el.style.left = x + '%';
            el.style.top = y + '%';
            el.innerText = state.quadrats.length + 1;
            el.addEventListener('mousedown', (ev) => handleQuadratClick(ev, id));
            el.addEventListener('touchstart', (ev) => handleQuadratClick(ev, id));

            DOM.simArea.appendChild(el);
            state.quadrats.push({
                id, x, y,
                wPct, hPct,
                wM: sizeM, hM: sizeM,
                userCount: null, element: el
            });
        }

        function handleQuadratClick(e, id)
        {
            e.stopPropagation();
            const qIndex = state.quadrats.findIndex(q => q.id === id);
            const q = state.quadrats[qIndex];

            if (state.mode === 'counting')
            {
                openCountModal(q);
            } else if (state.mode === 'delete')
            {
                q.element.remove();
                state.quadrats.splice(qIndex, 1);
                state.quadrats.forEach((item, idx) => item.element.innerText = idx + 1);
            } else if (state.mode === 'move')
            {
                startDrag(e, q);
            }
        }

        function startDrag(e, q)
        {
            const startX = e.clientX || e.touches[0].clientX;
            const startY = e.clientY || e.touches[0].clientY;
            const startL = parseFloat(q.element.style.left);
            const startT = parseFloat(q.element.style.top);
            const rect = DOM.simArea.getBoundingClientRect();

            const onMove = (evt) =>
            {
                const cx = evt.clientX || evt.touches[0].clientX;
                const cy = evt.clientY || evt.touches[0].clientY;
                const dx = ((cx - startX) / rect.width) * 100;
                const dy = ((cy - startY) / rect.height) * 100;
                let nx = Math.max(q.wPct / 2, Math.min(100 - q.wPct / 2, startL + dx));
                let ny = Math.max(q.hPct / 2, Math.min(100 - q.hPct / 2, startT + dy));

                // ç§»åŠ¨æ—¶çš„è¾¹ç•Œé™åˆ¶
                if (state.settings.shape === 'circle' || state.settings.shape === 'ring')
                {
                    if (!isQuadratValid(nx, ny, q.wPct / 2, q.hPct / 2)) return;
                }

                q.element.style.left = nx + '%';
                q.element.style.top = ny + '%';
                q.tempX = nx; q.tempY = ny;
            };
            const onUp = () =>
            {
                if (q.tempX) { q.x = q.tempX; q.y = q.tempY; }
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('touchend', onUp);
            };
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
            document.addEventListener('touchmove', onMove, { passive: false });
            document.addEventListener('touchend', onUp);
        }

        // --- ç»Ÿè®¡é€»è¾‘ ---

        function startStatistics()
        {
            if (state.quadrats.length === 0)
            {
                alert("è¯·å…ˆæ”¾ç½®æ ·æ–¹");
                return;
            }

            state.targetSpeciesId = DOM.targetSelect.value;
            const targetSp = state.settings.species.find(s => s.id === state.targetSpeciesId);
            if (!targetSp) { alert("è¯·é€‰æ‹©æœ‰æ•ˆçš„ç»Ÿè®¡ç‰©ç§"); return; }

            state.mode = 'counting';
            Object.values(DOM.btns).forEach(b => { b.disabled = true; b.classList.remove('highlight'); });

            document.getElementById('stats-panel').style.display = 'block';
            document.getElementById('stats-target-name').innerText = targetSp.name;
            document.getElementById('stats-target-name').style.color = targetSp.color;
            document.getElementById('stats-target-name').style.fontWeight = "bold";
            document.getElementById('mode-info').innerText = "ç»Ÿè®¡æ¨¡å¼è¿›è¡Œä¸­...";

            document.getElementById('target-select-wrapper').style.pointerEvents = 'none';
            document.getElementById('target-select-wrapper').style.opacity = '0.7';
        }

        function openCountModal(q)
        {
            const targetSp = state.settings.species.find(s => s.id === state.targetSpeciesId);
            document.getElementById('modal-target-name').innerText = targetSp.name;
            document.getElementById('modal-target-name').style.color = targetSp.color;

            DOM.modal.style.display = 'flex';
            DOM.modal.querySelector('input').value = q.userCount !== null ? q.userCount : '';
            setTimeout(() => DOM.modal.querySelector('input').focus(), 100);

            const container = document.getElementById('modal-view');
            container.innerHTML = '';
            const containerRect = container.getBoundingClientRect();
            const VIEW_SIZE_PX = containerRect.width;

            const viewScale = 1.2;
            const viewMeters = q.wM * viewScale;

            const boxSizePx = (q.wM / viewMeters) * VIEW_SIZE_PX;

            const box = document.createElement('div');
            box.style.cssText = `
            width:${boxSizePx}px; height:${boxSizePx}px; 
            border:3px dashed #ff4757; 
            position:absolute; top:50%; left:50%; 
            transform:translate(-50%,-50%);
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        `;
            container.appendChild(box);

            const widthM = state.settings.areaSize;
            let heightM = widthM;
            if (state.settings.shape === 'rect169') heightM = widthM * 9 / 16;

            const cxPct = q.x;
            const cyPct = q.y;

            state.plants.forEach(p =>
            {
                const dxPct = p.x - cxPct;
                const dyPct = p.y - cyPct;

                const dxM = (dxPct / 100) * widthM;
                const dyM = (dyPct / 100) * heightM;

                if (Math.abs(dxM) <= viewMeters / 2 && Math.abs(dyM) <= viewMeters / 2)
                {
                    const px = (dxM / viewMeters) * VIEW_SIZE_PX + VIEW_SIZE_PX / 2;
                    const py = (dyM / viewMeters) * VIEW_SIZE_PX + VIEW_SIZE_PX / 2;

                    const el = createPlantElement(p.size, p.color, p.shape, p.style);
                    el.style.position = 'absolute';
                    el.style.left = px + 'px';
                    el.style.top = py + 'px';

                    if (p.speciesId === state.targetSpeciesId)
                    {
                        el.classList.add('plant-highlight');
                    } else
                    {
                        el.classList.add('plant-dimmed');
                    }
                    container.appendChild(el);
                }
            });

            state.currentQuadrat = q;
        }

        function closeModal() { DOM.modal.style.display = 'none'; }

        function submitCount()
        {
            const val = parseInt(DOM.modal.querySelector('input').value);
            if (isNaN(val) || val < 0) return;

            state.currentQuadrat.userCount = val;
            state.currentQuadrat.element.classList.add('completed');

            calculateTrueCount(state.currentQuadrat);
            closeModal();
            checkAllCompleted();
        }

        function calculateTrueCount(q)
        {
            const halfW = q.wPct / 2;
            const halfH = q.hPct / 2;
            const l = q.x - halfW, r = q.x + halfW;
            const t = q.y - halfH, b = q.y + halfH;
            const eps = 0.0001;

            let count = 0;
            state.plants.forEach(p =>
            {
                if (p.speciesId !== state.targetSpeciesId) return;

                let inX = (p.x > l + eps && p.x < r - eps) || Math.abs(p.x - l) <= eps;
                let inY = (p.y > t + eps && p.y < b - eps) || Math.abs(p.y - t) <= eps;
                if (inX && inY) count++;
            });
            q.trueCount = count;
        }

        function checkAllCompleted()
        {
            if (state.quadrats.every(q => q.userCount !== null))
            {
                let uSum = 0, tSum = 0;
                state.quadrats.forEach(q =>
                {
                    const area = q.wM * q.hM;
                    uSum += q.userCount / area;
                    tSum += q.trueCount / area;
                });
                const uAvg = uSum / state.quadrats.length;

                const targetTotal = state.plants.filter(p => p.speciesId === state.targetSpeciesId).length;

                let totalArea = 0;
                const w = state.settings.areaSize;
                const { shape, innerSize, startAngle, endAngle } = state.settings;

                if (shape === 'square')
                {
                    totalArea = w * w;
                } else if (shape === 'rect169')
                {
                    totalArea = w * (w * 9 / 16);
                } else if (shape === 'circle' || shape === 'ring')
                {
                    // è®¡ç®—è§’åº¦æ¯”ä¾‹
                    let angleSpan = 0;
                    if (startAngle === endAngle) angleSpan = 360;
                    else if (startAngle < endAngle) angleSpan = endAngle - startAngle;
                    else angleSpan = (360 - startAngle) + endAngle;

                    const ratio = angleSpan / 360;

                    const rOut = w / 2;
                    const rIn = shape === 'ring' ? innerSize / 2 : 0;

                    totalArea = Math.PI * (Math.pow(rOut, 2) - Math.pow(rIn, 2)) * ratio;
                }

                const trueDensity = targetTotal / totalArea;

                const err = trueDensity === 0 ? (uAvg === 0 ? 0 : 100) : Math.abs(uAvg - trueDensity) / trueDensity * 100;

                const spName = state.settings.species.find(s => s.id === state.targetSpeciesId).name;

                document.getElementById('result-display').style.display = 'block';
                document.getElementById('res-name').innerText = spName;
                document.getElementById('user-density').innerText = uAvg.toFixed(4);
                document.getElementById('true-density').innerText = trueDensity.toFixed(4);
                document.getElementById('error-rate').innerText = err.toFixed(2);
            }
        }

        function resetUIState()
        {
            DOM.simArea.innerHTML = '';
            document.getElementById('stats-panel').style.display = 'none';
            document.getElementById('result-display').style.display = 'none';
            document.getElementById('target-select-wrapper').style.pointerEvents = 'auto';
            document.getElementById('target-select-wrapper').style.opacity = '1';

            Object.values(DOM.btns).forEach(b => b.disabled = false);
            document.getElementById('mode-info').innerText = "è¯·é€‰æ‹©æ“ä½œæ¨¡å¼";
        }

        function showToast(x, y, text)
        {
            DOM.toast.innerText = text;
            DOM.toast.style.left = x + 'px';
            DOM.toast.style.top = y + 'px';
            DOM.toast.classList.add('show');
            setTimeout(() => DOM.toast.classList.remove('show'), 2000);
        }

        function switchTab(t)
        {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + t).classList.add('active');
            document.querySelectorAll('.tab-btn')[t === 'main' ? 0 : 1].classList.add('active');
        }

        init();

    </script>
</body>

</html>