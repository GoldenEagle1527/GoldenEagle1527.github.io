<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- è§†å£è®¾ç½®ï¼Œç¡®ä¿ç§»åŠ¨ç«¯ç¼©æ”¾æ­£å¸¸ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ ‡è®°é‡æ•æ¨¡æ‹Ÿå®éªŒ</title>
    <link rel="stylesheet" href="../modules/qr-popup/css/qr-popup.css">
    <style>
        /* --- CSS å˜é‡å®šä¹‰ (æµ…è‰²/æ·±è‰²æ¨¡å¼) --- */
        :root {
            --bg-body: #f0f2f5;
            --bg-panel: #ffffff;
            --bg-input: #ffffff;
            --bg-log: #fafafa;
            --bg-status: #e3f2fd;
            --border-color: #ddd;
            --text-main: #333333;
            --text-sec: #666666;
            --text-status: #1565c0;
            --color-primary: #2196F3;
            --color-primary-hover: #1976D2;
            --color-secondary: #ff9800;
            --color-secondary-hover: #f57c00;
            --color-share: #607d8b;
            --color-share-hover: #455a64;
            --color-disabled: #e0e0e0;
            --text-disabled: #9e9e9e;
            --tab-bg: #f5f5f5;
            --tab-active-bg: #ffffff;
            --sim-bg: #81C784; /* ä¿æŒè‰åœ°é¢œè‰²ï¼Œæ·±è‰²æ¨¡å¼ä¸‹ç¨å¾®è°ƒæš— */
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #121212;
                --bg-panel: #1e1e1e;
                --bg-input: #2c2c2c;
                --bg-log: #181818;
                --bg-status: #1a3b52;
                --border-color: #333333;
                --text-main: #e0e0e0;
                --text-sec: #b0b0b0;
                --text-status: #90caf9;
                --color-primary: #1976D2;
                --color-primary-hover: #1565c0;
                --color-secondary: #f57c00;
                --color-secondary-hover: #ef6c00;
                --color-share: #546e7a;
                --color-share-hover: #455a64;
                --color-disabled: #424242;
                --text-disabled: #757575;
                --tab-bg: #2c2c2c;
                --tab-active-bg: #1e1e1e;
                --sim-bg: #388E3C; /* æ·±è‰²æ¨¡å¼ä¸‹è‰åœ°é¢œè‰²å˜æš—ï¼Œå‡å°‘åˆºçœ¼ */
            }
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background-color: var(--bg-body);
            color: var(--text-main);
        }

        #app {
            display: flex;
            height: 100vh;
            width: 100vw;
            flex-direction: row; /* é»˜è®¤æ¡Œé¢ç«¯ï¼šå·¦å³å¸ƒå±€ */
        }

        /* å·¦ä¾§åŠŸèƒ½åŒº (Desktop) */
        #control-panel {
            width: 360px; /* ç¨å¾®åŠ å®½ä»¥é€‚åº”è§¦æ‘¸ */
            background-color: var(--bg-panel);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 10;
        }

        h2 {
            margin: 0;
            color: var(--text-main);
            text-align: center;
            border-bottom: 2px solid #4CAF50;
            padding: 15px 20px;
            font-size: 1.2rem;
        }

        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--tab-bg);
        }

        .tab {
            flex: 1;
            padding: 14px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-size: 16px;
            color: var(--text-sec);
        }

        .tab.active {
            background: var(--tab-active-bg);
            border-bottom: 2px solid var(--color-primary);
            font-weight: bold;
            color: var(--text-main);
        }

        .tab-content {
            flex: 1;
            display: none;
            padding: 15px;
            overflow-y: auto;
            /* ç§»åŠ¨ç«¯æ»šåŠ¨ä½“éªŒä¼˜åŒ– */
            -webkit-overflow-scrolling: touch; 
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .status-box {
            background: var(--bg-status);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            color: var(--text-status);
            font-weight: bold;
            text-align: center;
            border: 1px solid rgba(33, 150, 243, 0.2);
            font-size: 1rem;
            line-height: 1.4;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }

        button {
            padding: 14px;
            font-size: 1rem;
            cursor: pointer;
            background-color: var(--color-primary);
            color: white;
            border: none;
            border-radius: 6px;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button:active {
            transform: translateY(1px);
        }

        button:disabled {
            background-color: var(--color-disabled);
            color: var(--text-disabled);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        button.secondary {
            background-color: var(--color-secondary);
            justify-content: center;
        }
        button.share-btn {
            background-color: var(--color-share);
            justify-content: center;
            margin-top: 15px;
        }

        .btn-count {
            background: rgba(0,0,0,0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.9rem;
            min-width: 40px;
            text-align: center;
        }

        .log-area {
            flex: 1;
            background: var(--bg-log);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
            color: var(--text-sec);
            margin-bottom: 10px;
        }

        .log-entry { margin-bottom: 6px; border-bottom: 1px dashed var(--border-color); padding-bottom: 2px; }
        .log-info { color: #039be5; }
        .log-success { color: #43a047; font-weight: bold; }
        .log-warn { color: #fdd835; }
        /* æ·±è‰²æ¨¡å¼ä¸‹è­¦å‘Šè‰²å¾®è°ƒ */
        @media (prefers-color-scheme: dark) {
            .log-warn { color: #fbc02d; } 
        }

        .log-result { 
            background-color: rgba(255, 152, 0, 0.1); 
            border-left: 4px solid var(--color-secondary); 
            padding: 8px; 
            margin-top: 5px; 
            color: var(--color-secondary);
            font-weight: bold;
        }

        /* è®¾ç½®åŒº */
        .settings-group {
            margin-bottom: 15px;
        }
        .settings-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-size: 0.95rem; 
            color: var(--text-sec); 
        }
        .settings-group input { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 6px; 
            font-size: 1rem;
            background-color: var(--bg-input);
            color: var(--text-main);
        }

        /* å³ä¾§æ¨¡æ‹ŸåŒº (Desktop) */
        #simulation-area {
            flex: 1;
            position: relative;
            background-color: var(--sim-bg); 
            overflow: hidden;
            cursor: crosshair;
        }

        canvas { display: block; width: 100%; height: 100%; }

        .tooltip {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            pointer-events: none;
            font-size: 1rem;
            z-index: 100;
            transition: opacity 0.3s;
            white-space: nowrap;
        }

        /* --- ç§»åŠ¨ç«¯é€‚é… (Media Queries) --- */
        @media (max-width: 768px) {
            #app {
                /* å…³é”®ï¼šä½¿ç”¨ column-reverse ä½¿å¾— HTMLç»“æ„ä¸­åå®šä¹‰çš„ Sim åŒºåœ¨é¡¶éƒ¨ï¼Œå…ˆå®šä¹‰çš„ Control åŒºåœ¨åº•éƒ¨ */
                flex-direction: column-reverse; 
            }

            #control-panel {
                width: 100%;
                /* æ§åˆ¶é¢æ¿å æ®å‰©ä½™ç©ºé—´ï¼Œä½†ä¸ä½äºä¸€å®šé«˜åº¦ */
                flex: 1;
                border-right: none;
                border-top: 1px solid var(--border-color);
                height: auto;
                max-height: 60vh; /* é˜²æ­¢æŒ¤å‹æ¨¡æ‹ŸåŒº */
            }

            #simulation-area {
                /* æ¨¡æ‹ŸåŒºåŸŸå›ºå®šé«˜åº¦ï¼Œå æ®å±å¹•ä¸ŠåŠéƒ¨åˆ† */
                height: 45vh;
                flex: none; /* ç¦æ­¢ä¼¸ç¼© */
                border-bottom: 1px solid var(--border-color);
            }

            h2 {
                padding: 10px;
                font-size: 1rem;
            }

            .tab {
                padding: 10px;
                font-size: 14px;
            }

            .tab-content {
                padding: 10px;
            }
            
            button {
                padding: 10px; /* å‡å°æŒ‰é’®å†…è¾¹è· */
                font-size: 0.9rem;
            }
            
            .log-area {
                font-size: 0.8rem;
            }

            .tooltip {
                top: 10px;
                font-size: 0.85rem;
                padding: 4px 12px;
            }
        }
    </style>
</head>
<body>

<div id="app">
    <!-- æ§åˆ¶é¢æ¿ -->
    <div id="control-panel">
        <h2>æ ‡è®°é‡æ•å®éªŒ</h2>
        
        <div class="tab-container">
            <div class="tab active" data-tab="main">æ“ä½œ</div>
            <div class="tab" data-tab="settings">è®¾ç½®</div>
        </div>
        
        <div class="tab-content active" id="main-tab">
            <div id="status-text" class="status-box">ç‚¹å‡»"é‡ç½®"åˆå§‹åŒ–</div>

            <div class="btn-group">
                <button id="btn-start-1" onclick="startCapture1()" disabled>
                    <span>1. ç¬¬ä¸€æ¬¡æ•è·</span>
                    <span id="count-1" class="btn-count">0/0</span>
                </button>
                <button id="btn-mark" onclick="markAndRelease()" disabled>
                    <span>2. æ ‡è®°å¹¶é‡Šæ”¾</span>
                </button>
                <button id="btn-start-2" onclick="startCapture2()" disabled>
                    <span>3. ç¬¬äºŒæ¬¡æ•è·</span>
                    <span id="count-2" class="btn-count">0/0</span>
                </button>
                <button id="btn-calculate" onclick="calculateResult()" disabled>
                    <span>4. è®¡ç®—ç»“æœ</span>
                </button>
                <button class="secondary" onclick="resetExperiment()">é‡ç½® / ç”ŸæˆåŠ¨ç‰©</button>
            </div>

            <div class="log-area" id="log-content"></div>
        </div>
        
        <div class="tab-content" id="settings-tab">
            <div class="settings-group">
                <label>åŠ¨ç‰©æ€»æ•° (N)</label>
                <input type="number" id="setting-count" value="100" min="10" max="2000">
            </div>
            <div class="settings-group">
                <label>ç§»åŠ¨é€Ÿåº¦ (1-10)</label>
                <input type="number" id="setting-speed" value="1" min="1" max="10">
            </div>
            <div class="settings-group">
                <label>åŠ¨ç‰©å¤§å° (1-30)</label>
                <input type="number" id="setting-size" value="30" min="1" max="30">
            </div>
            <div class="settings-group">
                <label>ç¬¬ä¸€æ¬¡æ•è·é™åˆ¶</label>
                <input type="number" id="setting-limit1" value="20" min="5" max="100">
            </div>
            <div class="settings-group">
                <label>ç¬¬äºŒæ¬¡æ•è·é™åˆ¶</label>
                <input type="number" id="setting-limit2" value="10" min="5" max="100">
            </div>
            
            <button class="secondary share-btn" onclick="generateShareLink()">
                ğŸ”— ç”Ÿæˆåˆ†äº«é“¾æ¥
            </button>
        </div>
    </div>

    <!-- æ¨¡æ‹ŸåŒºåŸŸ -->
    <div id="simulation-area">
        <canvas id="simCanvas"></canvas>
        <div id="canvas-tooltip" class="tooltip">å‡†å¤‡å°±ç»ª</div>
    </div>
</div>

<!-- å¼•å…¥ä¾èµ–åº“ -->
<script src="../modules/qr-popup/js/qrcode.min.js"></script>
<!-- å¼•å…¥åŠŸèƒ½æ¨¡å— -->
<script src="../modules/qr-popup/js/qr-popup.js"></script>

<script>
    // --- æ ¸å¿ƒå˜é‡ ---
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('simulation-area');

    // å®éªŒæ•°æ®
    let N_real = 200;
    let M = 0; // ç¬¬ä¸€æ¬¡æ ‡è®°æ•°
    let n = 0; // ç¬¬äºŒæ¬¡æ•è·æ€»æ•°
    let m = 0; // ç¬¬äºŒæ¬¡é‡æ•æ ‡è®°æ•°
    let N_est = 0; 

    // çŠ¶æ€æœº
    let currentState = 'IDLE';

    let animals = [];
    let animalSize = 4;
    let captureLimit1 = 30;
    let captureLimit2 = 40;
    let speedMultiplier = 3;
    let animationId;

    // SVG å›¾åƒå¯¹è±¡
    let imgUnmarked = new Image();
    let imgMarked = new Image();
    let imagesLoaded = 0;
    
    function loadImages() {
        return new Promise((resolve) => {
            function checkAllLoaded() {
                imagesLoaded++;
                if (imagesLoaded === 2) resolve();
            }
            imgUnmarked.onload = checkAllLoaded;
            imgMarked.onload = checkAllLoaded;
            imgUnmarked.src = 'unmarked.svg';
            imgMarked.src = 'marked.svg';
        });
    }

    // --- åˆå§‹åŒ–ä¸å“åº”å¼ ---
    function resizeCanvas() {
        // ç¡®ä¿ Canvas å°ºå¯¸åŒ¹é…å®¹å™¨çš„å®é™…åƒç´ å°ºå¯¸
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // --- æ ‡ç­¾é¡µåˆ‡æ¢ ---
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
        });
    });

    // --- URL é…ç½®åŠŸèƒ½ ---
    function applyUrlSettings() {
        const params = new URLSearchParams(window.location.search);
        const mappings = {
            'N': 'setting-count', 'sp': 'setting-speed',
            'sz': 'setting-size', 'l1': 'setting-limit1', 'l2': 'setting-limit2'
        };
        for (const [key, id] of Object.entries(mappings)) {
            if (params.has(key) && !isNaN(params.get(key))) {
                document.getElementById(id).value = params.get(key);
            }
        }
    }

    function generateShareLink() {
        const baseUrl = window.location.href.split('?')[0];
        const params = new URLSearchParams();
        params.set('N', document.getElementById('setting-count').value);
        params.set('sp', document.getElementById('setting-speed').value);
        params.set('sz', document.getElementById('setting-size').value);
        params.set('l1', document.getElementById('setting-limit1').value);
        params.set('l2', document.getElementById('setting-limit2').value);

        const shareUrl = `${baseUrl}?${params.toString()}`;
        if (window.QrPopupModule && typeof window.QrPopupModule.show === 'function') {
            window.QrPopupModule.show(shareUrl);
        } else {
            prompt("å¤åˆ¶é“¾æ¥ï¼š", shareUrl);
        }
    }

    // --- é¼ æ ‡/è§¦æ‘¸äº¤äº’ ---
    // ç»Ÿä¸€å¤„ç†åæ ‡è½¬æ¢
    function handleInput(clientX, clientY) {
        if (currentState !== 'CAPTURING_1' && currentState !== 'CAPTURING_2') return;

        const rect = canvas.getBoundingClientRect();
        // å¤„ç†Canvasåˆ†è¾¨ç‡ä¸æ˜¾ç¤ºå¤§å°çš„æ¯”ä¾‹
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const clickX = (clientX - rect.left) * scaleX;
        const clickY = (clientY - rect.top) * scaleY;

        for (let animal of animals) {
            if (animal.isTrapped) continue;
            
            // é€‚å½“å¢åŠ ç§»åŠ¨ç«¯çš„ç‚¹å‡»åˆ¤å®šèŒƒå›´
            const hitBox = Math.max(animal.size * 1.5, 20); 
            const dx = animal.x - clickX;
            const dy = animal.y - clickY;
            
            if (Math.sqrt(dx*dx + dy*dy) <= hitBox) {
                animal.isTrapped = true;
                
                if (currentState === 'CAPTURING_1') {
                    M = animals.filter(a => a.isTrapped).length;
                    updateButtonCount('count-1', M, captureLimit1);
                    if (M >= captureLimit1) endCapture1();
                } else if (currentState === 'CAPTURING_2') {
                    n = animals.filter(a => a.isTrapped).length;
                    m = animals.filter(a => a.isTrapped && a.isMarked).length;
                    updateButtonCount('count-2', n, captureLimit2);
                    if (n >= captureLimit2) endCapture2();
                }
                break;
            }
        }
    }

    canvas.addEventListener('mousedown', (e) => handleInput(e.clientX, e.clientY));
    
    // å¢åŠ è§¦æ‘¸æ”¯æŒ
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault(); // é˜²æ­¢æ»šåŠ¨
        const touch = e.touches[0];
        handleInput(touch.clientX, touch.clientY);
    }, {passive: false});

    // --- åŠ¨ç‰©ç±» ---
    class Animal {
        constructor() {
            this.x = Math.random() * (canvas.width - 10);
            this.y = Math.random() * (canvas.height - 10);
            const angle = Math.random() * Math.PI * 2;
            this.vx = Math.cos(angle);
            this.vy = Math.sin(angle);
            this.size = animalSize;
            this.isMarked = false;
            this.isTrapped = false;
        }

        update() {
            if (this.isTrapped) return;
            this.x += this.vx * speedMultiplier;
            this.y += this.vy * speedMultiplier;

            if (this.x <= 0 || this.x >= canvas.width) this.vx *= -1;
            if (this.y <= 0 || this.y >= canvas.height) this.vy *= -1;
            
            this.x = Math.max(0, Math.min(canvas.width, this.x));
            this.y = Math.max(0, Math.min(canvas.height, this.y));
        }

        draw() {
            const img = this.isMarked ? imgMarked : imgUnmarked;
            const size = this.size * 2;
            
            if (imagesLoaded === 2) {
                ctx.drawImage(img, this.x - size/2, this.y - size/2, size, size);
            } else {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.isMarked ? '#d32f2f' : '#424242';
                ctx.fill();
            }
            
            if (this.isTrapped) {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size + 3, 0, Math.PI * 2);
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }
        
        resetPosition() {
            this.x = Math.random() * (canvas.width - 10);
            this.y = Math.random() * (canvas.height - 10);
            const angle = Math.random() * Math.PI * 2;
            this.vx = Math.cos(angle);
            this.vy = Math.sin(angle);
        }
    }

    // --- é€»è¾‘å¾ªç¯ ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        animals.filter(a => !a.isTrapped).forEach(a => a.draw());
        animals.filter(a => a.isTrapped).forEach(a => a.draw());
        animals.forEach(a => a.update());
    }

    function loop() {
        draw();
        animationId = requestAnimationFrame(loop);
    }

    function resetExperiment() {
        N_real = parseInt(document.getElementById('setting-count').value) || 200;
        speedMultiplier = parseFloat(document.getElementById('setting-speed').value) || 3;
        animalSize = parseInt(document.getElementById('setting-size').value) || 4;
        captureLimit1 = parseInt(document.getElementById('setting-limit1').value) || 30;
        captureLimit2 = parseInt(document.getElementById('setting-limit2').value) || 40;

        animals = [];
        for (let i = 0; i < N_real; i++) animals.push(new Animal());
        
        M = 0; n = 0; m = 0; N_est = 0;
        
        document.getElementById('log-content').innerHTML = '';
        log(`å®éªŒé‡ç½®ã€‚æ€»æ•°: ${N_real}`, 'info');
        updateStatus("ç‚¹å‡»'1. ç¬¬ä¸€æ¬¡æ•è·'å¼€å§‹");
        updateTooltip("å‡†å¤‡å°±ç»ª");
        
        disableAllButtons();
        currentState = 'READY_1';
        enableButton('btn-start-1');
        
        updateButtonCount('count-1', 0, captureLimit1);
        updateButtonCount('count-2', 0, captureLimit2);

        if (animationId) cancelAnimationFrame(animationId);
        loop();
    }

    function startCapture1() {
        currentState = 'CAPTURING_1';
        disableAllButtons();
        log(">>> ç¬¬ä¸€æ¬¡æ•è·å¼€å§‹", 'info');
        updateStatus(`æ•è·ä¸­ (ç›®æ ‡: ${captureLimit1})`);
        updateTooltip("ç‚¹å‡»åŠ¨ç‰©æ•è·");
    }

    function endCapture1() {
        M = animals.filter(a => a.isTrapped).length;
        currentState = 'MARKED';
        log(`ç¬¬ä¸€æ¬¡æ•è·ç»“æŸã€‚M = ${M}`, 'success');
        updateStatus(`å®Œæˆ (${M}åª)ï¼Œè¯·æ ‡è®°`);
        updateTooltip("ç‚¹å‡»'2. æ ‡è®°å¹¶é‡Šæ”¾'");
        enableButton('btn-mark');
    }

    function markAndRelease() {
        let count = 0;
        animals.forEach(a => {
            if (a.isTrapped) {
                a.isMarked = true;
                a.isTrapped = false;
                count++;
            }
        });
        animals.forEach(a => a.resetPosition());
        currentState = 'READY_2';
        log(`å·²æ ‡è®° ${count} åªå¹¶é‡Šæ”¾ã€‚`, 'info');
        updateStatus("å·²é‡Šæ”¾ã€‚å¼€å§‹ç¬¬äºŒæ¬¡æ•è·");
        updateTooltip("ç‚¹å‡»'3. ç¬¬äºŒæ¬¡æ•è·'");
        disableAllButtons();
        enableButton('btn-start-2');
    }

    function startCapture2() {
        currentState = 'CAPTURING_2';
        disableAllButtons();
        log(">>> ç¬¬äºŒæ¬¡æ•è·å¼€å§‹", 'info');
        updateStatus(`æ•è·ä¸­ (ç›®æ ‡: ${captureLimit2})`);
        updateTooltip("ç‚¹å‡»åŠ¨ç‰©æ•è·");
    }

    function endCapture2() {
        const trapped = animals.filter(a => a.isTrapped);
        n = trapped.length;
        m = trapped.filter(a => a.isMarked).length;
        currentState = 'FINISHED';
        log(`ç¬¬äºŒæ¬¡ç»“æŸã€‚n=${n}, m=${m}`, 'success');
        updateStatus("å®Œæˆï¼Œè¯·è®¡ç®—");
        updateTooltip("ç‚¹å‡»'4. è®¡ç®—ç»“æœ'");
        enableButton('btn-calculate');
    }

    function calculateResult() {
        if (m === 0) {
            log("å¤±è´¥ï¼šæœªé‡æ•åˆ°æ ‡è®°ä¸ªä½“ (m=0)ã€‚", 'warn');
        } else {
            N_est = Math.round((M * n) / m);
            const err = ((Math.abs(N_est-N_real)/N_real)*100).toFixed(2);
            
            const div = document.getElementById('log-content');
            div.innerHTML += `
                <div class="log-result">
                    <div>N = (${M} Ã— ${n}) / ${m} â‰ˆ ${N_est}</div>
                    <div style="font-weight:normal; opacity:0.8; font-size:0.9em">çœŸå®å€¼: ${N_real} (è¯¯å·®: ${err}%)</div>
                </div>
            `;
            div.scrollTop = div.scrollHeight;
            updateStatus("å®éªŒå®Œæˆ");
            updateTooltip("å®éªŒå®Œæˆ");
        }
    }

    function log(msg, type='normal') {
        const div = document.getElementById('log-content');
        const d = document.createElement('div');
        d.className = 'log-entry ' + (type === 'info' ? 'log-info' : type === 'success' ? 'log-success' : type === 'warn' ? 'log-warn' : '');
        d.innerText = `[${new Date().toLocaleTimeString().slice(3)}] ${msg}`;
        div.appendChild(d);
        div.scrollTop = div.scrollHeight;
    }

    function updateStatus(txt) { document.getElementById('status-text').innerText = txt; }
    function updateTooltip(txt) { document.getElementById('canvas-tooltip').innerText = txt; }
    function enableButton(id) { document.getElementById(id).disabled = false; }
    function disableAllButtons() {
        ['btn-start-1', 'btn-mark', 'btn-start-2', 'btn-calculate'].forEach(id => document.getElementById(id).disabled = true);
    }
    function updateButtonCount(id, current, limit) {
        document.getElementById(id).innerText = `${current}/${limit}`;
    }

    applyUrlSettings();
    loadImages().then(resetExperiment).catch(resetExperiment);
</script>
</body>
</html>